<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KYEC-å°ˆåˆ©æª¢ç´¢ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #cdcfd0;
            min-height: 100vh;
            color: #5f624e;
        }

        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            background: #ede9e4;
            min-height: 100vh;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.1);
            display: flex;
            position: relative;
        }

        .sidebar {
            width: 320px;
            background: #658398;
            color: #fefefd;
            padding: 2rem;
            overflow-y: auto;
        }

        .sidebar h2 {
            font-size: 1.75rem;        /* æˆ–å¯«æˆ font-weight: 700; */
            margin-bottom: 2rem;
            text-align: center;
            background: linear-gradient(45deg, #e4e4dc, #fefefd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            margin-right: 0;
            transition: margin-right 0.3s ease;
        }

        .main-content.chat-open {
            margin-right: 400px;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .header h1 {
            font-size: 2.5rem;
            background: linear-gradient(45deg, #5a5859, #e4e4dc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #666;
            font-size: 1.1rem;
        }

        .alert-banner {
            background: linear-gradient(135deg, #EDE9E4 0%, #E4E4DC 100%);
            border: 1px solid #658398;
            color: #EDE9E4;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px #0c5460;
        }

        .alert-banner h3 {
            margin-bottom: 0.5rem;
            color: #658398;
        }

        .tabs {
            display: flex;
            background: #cdcfd0;
            border-radius: 10px;
            margin-bottom: 2rem;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .tab {
            flex: 1;
            padding: 1rem 2rem;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .tab.active {
            background: linear-gradient(45deg, #658398, #8f9499);
            color: #ede9e4;
            transform: translateY(-2px);
        }

        .tab:hover:not(.active) {
            background: rgba(86, 115, 87, 0.1);
            transform: translateY(-1px);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.5s ease-in;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #555;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.8rem;
            border: 2px solid #5a5859;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #658398;
            box-shadow: 0 0 0 3px rgba(86, 115, 87, 0.1);
        }

        .form-group input[readonly] {
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: not-allowed;
            border-color: #dee2e6;
        }

        .btn {
            padding: 0.8rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            position: relative;
            overflow: hidden;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background: linear-gradient(45deg, #658398, #485c69);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(86, 115, 87, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(45deg, #cdcfd0, #485c69);
            color: #ede9e4;
        }

        .btn-secondary:hover:not(:disabled) {
            background: linear-gradient(45deg, #485c69, #cdcfd0);
            transform: translateY(-1px);
        }

        .btn-success {
            background: linear-gradient(45deg, #658398, #0c5460);
            color: #EDE9E4;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px #E4E4DC;
        }

        .btn-export {
            background: linear-gradient(45deg, #658398, #0c5460);
            color: #EDE9E4;
        }

        .btn-export:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px #E4E4DC;
        }

        .card {
            background: #fefefd;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
        }

        .card h3 {
            margin-bottom: 1.5rem;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .status-success {
            background: #EDE9E4;
            color: #658398;
        }

        .status-warning {
            background: #EDE9E4;
            color: #658398;
        }

        .status-error {
            background: #EDE9E4;
            color: #658398;
        }

        .status-testing {
            background: #EDE9E4;
            color: #658398;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
            margin: 1rem 0;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #658398, #8f9499);
            transition: width 0.5s ease;
            border-radius: 6px;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.8rem;
            font-weight: bold;
            color: #5a5859;
            text-shadow: 0 0 3px rgba(255,255,255,0.8);
        }

        .patent-card {
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 1rem;
            overflow: hidden;
            transition: all 0.3s ease;
            background: #fefefd;
            padding: 1.5rem;
        }

        .patent-card:hover {
            border-color: #658398;
            box-shadow: 0 4px 15px rgba(86, 115, 87, 0.1);
        }

        .patent-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #5a5859;
            margin-bottom: 0.5rem;
        }

        .patent-number {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .patent-metadata {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }

        .metadata-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .metadata-label {
            font-weight: 600;
            color: #5a5859;
            min-width: 60px;
        }

        .metadata-value {
            color: #666;
            flex: 1;
        }

        .country-flag {
            display: inline-block;
            width: 20px;
            height: 15px;
            border-radius: 2px;
            margin-right: 0.5rem;
            font-size: 0.8rem;
            text-align: center;
            line-height: 15px;
            color: white;
            font-weight: bold;
        }

        .country-tw { background: #ff0000; }
        .country-us { background: #b22234; }
        .country-jp { background: #bc002d; }
        .country-ep { background: #003399; }
        .country-kr { background: #003478; }
        .country-cn { background: #de2910; }
        .country-wo { background: #0066cc; }
        .country-other { background: #888; }

        .features-effects {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .features-effects h4 {
            margin-bottom: 0.5rem;
            color: #5a5859;
        }

        .features-list, .effects-list {
            list-style: none;
            padding: 0;
        }

        .features-list li, .effects-list li {
            padding: 0.2rem 0;
            font-size: 0.9rem;
            color: #666;
        }

        .features-list li:before {
            content: "â–ª ";
            margin-right: 0.5rem;
        }

        .effects-list li:before {
            content: "â–´ ";
            margin-right: 0.5rem;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 2rem;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e0e0e0;
            border-top: 4px solid #658398;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .settings-section {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .keyword-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .keyword-tag {
            background: rgba(86, 115, 87, 0.1);
            color: #658398;
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .keyword-selection {
            background: #f8f9fa;
            border: 1px solid #658398;
            border-radius: 10px;
            padding: 1.5rem;
            margin: 1.5rem 0;
        }

        .available-keywords {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            min-height: 100px;
        }

        .keyword-item, .synonym-item {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 0.3rem 0.8rem;
            margin: 0.2rem;
            border-radius: 15px;
            cursor: grab;
            user-select: none;
            font-size: 0.9rem;
        }

        .keyword-item:active, .synonym-item:active {
            cursor: grabbing;
        }

        .synonym-item {
            background: #6c757d;
        }

        .search-conditions {
            margin: 1rem 0;
        }

        .condition-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background: #fff;
        }

        .keywords-dropzone {
            flex: 1;
            min-height: 40px;
            border: 2px dashed #ffc107;
            background: #fff8e1;
            border-radius: 5px;
            padding: 0.5rem;
            position: relative;
        }

        .keywords-dropzone.dragover {
            border-color: #ff9800;
            background: #ffecb3;
        }

        .dropzone-hint {
            color: #666;
            font-style: italic;
        }

        .dropped-keywords {
            display: flex;
            flex-wrap: wrap;
            gap: 0.3rem;
        }

        .dropped-keyword {
            background: #28a745;
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            position: relative;
        }

        .dropped-keyword .remove-btn {
            margin-left: 0.3rem;
            cursor: pointer;
            font-weight: bold;
        }

        .field-selector, .logic-selector {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 0.5rem;
            border-radius: 4px;
            cursor: pointer;
        }

        .add-condition-btn {
            position: absolute;
            right: 1rem;
            bottom: 1rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #6f42c1;
            color: white;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .keyword-checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .keyword-checkbox {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background: white;
            border-radius: 5px;
            border: 1px solid #ddd;
            transition: all 0.3s ease;
        }

        .keyword-checkbox:hover {
            background: rgba(86, 115, 87, 0.1);
            border-color: #658398;
        }

        .keyword-checkbox input {
            margin-right: 0.5rem;
            width: auto;
        }

        .keyword-checkbox.selected {
            background: rgba(86, 115, 87, 0.2);
            border-color: #658398;
        }

        .custom-keywords-section {
            background: white;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .error-message {
            background: linear-gradient(135deg, #f5c6cb 0%, #E4E4DC 100%);
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid #fefefd;
        }

        .success-message {
            background: linear-gradient(135deg, #d4edda 0%, #E4E4DC 100%);
            color: #155724;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border: 1px solid #fefefd;
        }

        .grid {
            display: grid;
            gap: 1.5rem;
        }

        .grid-2 {
            grid-template-columns: 1fr 1fr;
        }

        .grid-3 {
            grid-template-columns: 1fr 1fr 1fr;
        }

        .no-results {
            text-align: center;
            padding: 2rem;
            color: #666;
            font-style: italic;
        }

        .patent-lookup {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .patent-lookup input {
            margin-bottom: 0.5rem;
        }

        .related-links {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            padding: 1rem;
        }

        .related-links a {
            color: #e4e4dc;
            text-decoration: none;
            display: block;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .related-links a:hover {
            color: #fefefd;
            text-decoration: underline;
        }

        .export-section {
            margin-top: 2rem;
            text-align: center;
        }

        /* Excelä¸Šå‚³ç›¸é—œæ¨£å¼ */
        .upload-area {
            border: 2px dashed #658398;
            border-radius: 10px;
            padding: 2rem;
            text-align: center;
            background: #f8f9fa;
            margin: 1rem 0;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #5a5859;
            background: #f0f0f0;
        }

        .upload-area.dragover {
            border-color: #658398;
            background: rgba(86, 115, 87, 0.1);
        }

        .upload-instructions {
            color: #666;
            margin-bottom: 1rem;
        }

        .upload-requirements {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            text-align: left;
        }

        .upload-requirements h4 {
            color: #658398;
            margin-bottom: 0.5rem;
        }

        .upload-requirements ul {
            margin-left: 1rem;
            color: #666;
        }

        .file-info {
            background: rgba(86, 115, 87, 0.1);
            border-radius: 5px;
            padding: 0.5rem;
            margin: 0.5rem 0;
            font-size: 0.9rem;
        }

        .analysis-summary {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
        }

        .analysis-summary h4 {
            color: #658398;
            margin-bottom: 0.5rem;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-item {
            text-align: center;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #658398;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }

        /* èŠå¤©ç•Œé¢æ¨£å¼ */
        .chat-panel {
            position: fixed;
            right: -400px;
            top: 0;
            width: 400px;
            height: 100vh;
            background: #fefefd;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
            transition: right 0.3s ease;
            z-index: 1000;
            display: flex;
            flex-direction: column;
        }

        .chat-panel.open {
            right: 0;
        }

        .chat-header {
            background: #658398;
            color: #fefefd;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .chat-close-btn {
            background: none;
            border: none;
            color: #fefefd;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chat-close-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .chat-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .chat-message {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
        }

        .chat-message.user {
            align-items: flex-end;
        }

        .chat-message.assistant {
            align-items: flex-start;
        }

        .chat-message.system {
            align-items: center;
        }

        .message-content {
            max-width: 80%;
            padding: 0.8rem;
            border-radius: 15px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .chat-icon-img {
            width: 50px;
            height: 50px;
            display: block;
        }

        .chat-message.user .message-content {
            background: #658398;
            color: #fefefd;
            border-bottom-right-radius: 5px;
        }

        .chat-message.assistant .message-content {
            background: #e9ecef;
            color: #495057;
            border-bottom-left-radius: 5px;
        }

        .chat-message.system .message-content {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            max-width: 90%;
            text-align: center;
            font-size: 0.8rem;
        }

        .message-time {
            font-size: 0.7rem;
            color: #6c757d;
            margin-top: 0.3rem;
            padding: 0 0.5rem;
        }

        .chat-input-area {
            padding: 1rem;
            border-top: 1px solid #e0e0e0;
            background: #fefefd;
        }

        .chat-input-group {
            display: flex;
            gap: 0.5rem;
        }

        .chat-input {
            flex: 1;
            padding: 0.8rem;
            border: 1px solid #ddd;
            border-radius: 20px;
            resize: none;
            max-height: 100px;
            font-family: inherit;
        }

        .chat-send-btn {
            background: #658398;
            color: #fefefd;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .chat-send-btn:hover:not(:disabled) {
            background: #5a7386;
        }

        .chat-send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .chat-toggle-btn {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: #658398;
            color: #fefefd;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            z-index: 999;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            transition: all 0.3s ease;
        }

        .chat-toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .chat-status {
            padding: 0.5rem;
            text-align: center;
            font-size: 0.8rem;
            color: #6c757d;
            border-bottom: 1px solid #e0e0e0;
        }

        .chat-typing {
            display: none;
            padding: 0.8rem;
            color: #6c757d;
            font-style: italic;
            font-size: 0.9rem;
        }

        .chat-typing.show {
            display: block;
        }

        .patent-abstract {
            background: #f8f9fa !important;
            border-left: 4px solid #658398 !important;
            padding: 1rem !important;
            margin: 1rem 0 !important;
            border-radius: 4px !important;
        }

        .patent-abstract h4 {
            color: #5a5859 !important;
            margin-bottom: 0.5rem !important;
            font-size: 1rem !important;
        }

        .patent-abstract p {
            color: #666 !important;
            line-height: 1.6 !important;
            margin: 0 !important;
            text-align: justify !important;
        }

        /* æ–°å¢ï¼šå°è©±è¨˜æ†¶åŠŸèƒ½æ¨£å¼ */
        .memory-indicator {
            background: rgba(255, 255, 255, 0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            color: #ffffff;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .memory-indicator.active {
            background: #4CAF50;
        }

        .memory-indicator.inactive {
            background: #FFC107;
            color: #333;
        }

        .memory-toggle-btn, .chat-history-btn, .clear-memory-btn {
            background: none;
            border: none;
            color: #fefefd;
            font-size: 1rem;
            cursor: pointer;
            padding: 0.2rem;
            border-radius: 3px;
            width: 25px;
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }

        .memory-toggle-btn:hover, .chat-history-btn:hover, .clear-memory-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .memory-status-panel {
            background: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
            padding: 0.5rem;
            font-size: 0.8rem;
            color: #666;
        }

        .memory-stats {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .chat-mode-selector {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
            color: #666;
        }

        .chat-mode-selector input[type="checkbox"] {
            margin-right: 0.3rem;
            width: auto;
        }

        /* æ¶ˆæ¯é¡å‹æ¨£å¼ */
        .chat-message.memory-enabled .message-content {
            border-left: 3px solid #4CAF50;
        }

        .chat-message.memory-disabled .message-content {
            border-left: 3px solid #FFC107;
        }

        .message-meta {
            font-size: 0.6rem;
            color: #999;
            margin-top: 0.2rem;
            font-style: italic;
            padding: 0 0.5rem;
        }

        /* èŠå¤©é ­éƒ¨ä½ˆå±€ */
        .chat-header-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .chat-header-right {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* æ¨¡æ…‹æ¡†æ¨£å¼ */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            max-width: 80%;
            max-height: 80%;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 1rem;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #658398;
            color: white;
        }

        .modal-header h3 {
            margin: 0;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .modal-body {
            max-height: 60vh;
            overflow-y: auto;
            padding: 0;
        }

        .history-item {
            margin-bottom: 1rem;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f8f9fa;
        }

        .history-time {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.3rem;
        }

        .history-question {
            font-weight: bold;
            margin-bottom: 0.3rem;
            color: #333;
        }

        .history-answer {
            color: #555;
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            .sidebar {
                width: 100%;
                order: 2;
            }
            .main-content {
                order: 1;
                margin-right: 0 !important;
            }
            .grid-2, .grid-3 {
                grid-template-columns: 1fr;
            }
            .chat-panel {
                width: 100%;
                right: -100%;
            }
            .chat-toggle-btn {
                bottom: 1rem;
                right: 1rem;
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }
        }

        .keyword-synonym-groups {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin: 1rem 0;
        }

        .keyword-group {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            background: #fafafa;
        }

        .keyword-group h4 {
            margin: 0 0 0.5rem 0;
            color: #333;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .main-keyword {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background: #fff;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .main-keyword input[type="checkbox"] {
            transform: scale(1.2);
        }

        .main-keyword label {
            font-weight: 600;
            color: #2c5aa0;
            margin: 0;
            cursor: pointer;
        }

        .keyword-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 5px;
        }

        .keyword-actions .btn {
            padding: 0.5rem 1.5rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }

        .keyword-actions .btn-warning {
            background: #ffc107;
            color: #212529;
        }

        .keyword-actions .btn-warning:hover {
            background: #e0a800;
        }

        .keyword-actions .btn-success {
            background: #28a745;
            color: white;
        }

        .keyword-actions .btn-success:hover {
            background: #218838;
        }

        .keyword-actions .btn-primary {
            background: #007bff;
            color: white;
        }

        .keyword-actions .btn-primary:hover {
            background: #0056b3;
        }

        /* ä¿®æ”¹ï¼šæ¢ä»¶è¡Œæ¨£å¼ï¼Œç‚ºå…§è¯+æŒ‰éˆ•é ç•™ç©ºé–“ */
        .condition-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            background: #fff;
            position: relative;
        }

        /* ä¿®æ”¹ï¼šå…§è¯+æŒ‰éˆ•æ¨£å¼ */
        .add-condition-btn-inline {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #6f42c1;
            color: white;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            flex-shrink: 0;
        }

        .add-condition-btn-inline:hover {
            background: #5a32a3;
        }

        /* ç§»é™¤èˆŠçš„çµ•å°å®šä½+æŒ‰éˆ•æ¨£å¼ */
        .add-condition-btn {
            display: none;
        }

        .synonyms-section {
            margin-left: 1rem;
        }

        .synonyms-section > label {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 0.5rem;
            display: block;
        }

        .synonym-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .synonym-option {
            display: flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.3rem 0.6rem;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }

        .synonym-option:hover {
            background: #f0f8ff;
            border-color: #5a9;
        }

        .synonym-option.selected {
            background: #e8f4f8;
            border-color: #5a9;
            color: #2c5aa0;
        }

        .synonym-option input[type="checkbox"] {
            margin: 0;
        }

        .synonym-option label {
            margin: 0;
            cursor: pointer;
            user-select: none;
        }

        .group-logic-indicator {
            font-size: 0.8rem;
            color: #888;
            text-align: center;
            margin: 0.5rem 0;
            font-style: italic;
        }

        .and-logic-separator {
            text-align: center;
                margin: 1rem 0;
            position: relative;
        }

        .and-logic-separator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #ddd;
            z-index: 1;
        }

        .and-logic-separator span {
            background: #fff;
            padding: 0.3rem 0.8rem;
            color: #666;
            font-weight: 600;
            border: 1px solid #ddd;
            border-radius: 12px;
            position: relative;
            z-index: 2;
        }

        @media (max-width: 768px) {
            .synonym-options {
                flex-direction: column;
            }
    
            .synonym-option {
                width: 100%;
                justify-content: flex-start;
            }
        }

        
    </style>
</head>
<body>
    <div class="main-container">
        <!-- å´é‚Šæ¬„ -->
        <div class="sidebar">
            <h2>ç³»çµ±è¨­å®š</h2>

            <div class="settings-section">
                <h3>GPSS API è¨­å®š</h3>
                <div class="form-group">
                    <input type="password" id="gpssApiKey" placeholder="è«‹è¼¸å…¥ API é©—è­‰ç¢¼">
                    <small style="color: #ede9e4;">âš  è«‹åˆ°æ™ºæ…§è²¡ç”¢å±€ç”³è«‹APIé©—è­‰ç¢¼</small>
                    <small style="color: #ede9e4;">âš  æ¯äººæ¯æ—¥æª¢ç´¢è¼¸å‡ºæµé‡é™åˆ¶ç‚º10,000ç­†<br/></small>
                    <small style="color: #ede9e4;">(æ­¤ç³»çµ±å–®æ¬¡æª¢ç´¢è¼¸å‡ºæœ€å¤š1,000ç­†)</small>
                </div>
                <button class="btn btn-secondary" id="testGpssBtn">APIé©—è­‰</button>
                <div class="status-indicator status-testing" id="gpssStatus">
                    <span>X</span> å°šæœªé©—è­‰
                </div>
            </div>

            <div class="settings-section">
                <h3>å°ˆåˆ©å…¨æ–‡æŸ¥è©¢<br/></h3>
                <div class="form-group">
                    <input style="margin: 0.5em 0;" type="text" id="patentLookupInput" placeholder="è¼¸å…¥å…¬é–‹å…¬å‘Šè™Ÿ">
                    <button class="btn btn-secondary" id="patentLookupBtn">æŸ¥è©¢å°ˆåˆ©</button>
                </div>
            </div>

            <div class="settings-section">
                <h3>ç›¸é—œé€£çµ</h3>
                <div class="related-links">
                    <a href="https://tiponet.tipo.gov.tw/gpss1/gpsskmc/gpssapi?@@0.532614314057245" target="_blank">
                        - GPSS APIé©—è­‰ç¢¼ç”³è«‹
                    </a>
                    <a href="https://www.tipo.gov.tw/" target="_blank">
                        - æ™ºæ…§è²¡ç”¢å±€å®˜ç¶²
                    </a>
                </div>
            </div>

            <div class="settings-section">
                <h3>API è¨­å®š</h3>
                <div class="form-group">
                    <input type="text" id="apiBaseUrl" value="http://localhost:8005" placeholder="APIåœ°å€">
                </div>
                <button class="btn btn-secondary" id="testApiBtn">æ¸¬è©¦APIé€£æ¥</button>
                <div class="status-indicator status-testing" id="apiStatus">
                    <span>â€¦</span> ç­‰å¾…æ¸¬è©¦
                </div>
            </div>

            <div class="settings-section">
                <h3>æœå‹™ç‹€æ…‹</h3>
                <div class="status-indicator status-testing" id="qwenStatus">
                    <span>?</span> Qwen æœå‹™
                </div>
            </div>
        </div>

        <!-- ä¸»è¦å…§å®¹å€ -->
        <div class="main-content">
            <div class="header">
                <h1 style="font-weight: bold;"><B>KYEC-å°ˆåˆ©æª¢ç´¢ç³»çµ±</B></h1>
                <p>ğŸƒ</p>
            </div>

            <!-- åˆ†é æ¨™ç±¤ -->
            <div class="tabs" id="tabContainer">
                <button class="tab active" data-tab="tech-search">æŠ€è¡“æè¿°æŸ¥è©¢</button>
                <button class="tab" data-tab="condition-search">æ¢ä»¶æŸ¥è©¢</button>
                <button class="tab" data-tab="excel-analysis">è³‡æ–™åˆ†æ</button>
            </div>

            <!-- æŠ€è¡“æè¿°æŸ¥è©¢ -->
            <div id="tech-search" class="tab-content active">
                <h2>æŠ€è¡“æè¿°æŸ¥è©¢</h2>
                <div class="form-group">
                    <label for="techDescription">è«‹è©³ç´°æè¿°æ‚¨è¦æŸ¥è©¢çš„æŠ€è¡“:</label>
                    <textarea id="techDescription" rows="6" placeholder="ä¾‹å¦‚ï¼šè‡ªå‹•åŒ–æ™¶åœ“æ¢é‡å°ç³»çµ±ï¼Œå…·å‚™ç²¾å¯†å®šä½æ§åˆ¶å’Œå¤šé»ä¸¦è¡Œæ¸¬è©¦åŠŸèƒ½ï¼Œé©ç”¨æ–¼é«˜é » RF æ™¶ç‰‡æ¸¬è©¦..."></textarea>
                </div>

                <button class="btn btn-primary" id="generateKeywordsBtn">ç”Ÿæˆé—œéµå­—</button>

                <!-- é—œéµå­—é¸æ“‡ç•Œé¢ -->
                <div id="keyword-selection" class="keyword-selection" style="display: none;">
                    <h3>è«‹æ‹–æ‹‰é—œéµå­—åˆ°æœç´¢æ¢ä»¶ä¸­</h3>

                    <div class="keyword-actions">
                        <button id="clear-all-conditions-btn" class="btn btn-warning">æ¸…é™¤å…¨éƒ¨</button>
                        <button id="auto-generate-conditions-btn" class="btn btn-success">ä¸€éµæª¢ç´¢</button>
                        <button id="manual-search-btn" class="btn btn-primary">æ‰‹å‹•æª¢ç´¢</button>
                    </div>
    
                    <div id="available-keywords" class="available-keywords">
                        <!-- å‹•æ…‹ç”Ÿæˆå¯æ‹–æ‹‰çš„é—œéµå­—å’ŒåŒç¾©è© -->
                    </div>

                    <div id="search-conditions" class="search-conditions">
                        <div class="condition-row" data-condition-index="0">
                            <div class="keywords-dropzone" data-condition="0">
                                <span class="dropzone-hint">æ‹–æ‹‰é—œéµå­—åˆ°é€™è£¡</span>
                                <div class="dropped-keywords"></div>
                            </div>
                            <select class="field-selector">
                                <option value="TI">å°ˆåˆ©åç¨±</option>
                                <option value="AB">æ‘˜è¦</option>
                                <option value="CL">å°ˆåˆ©ç¯„åœ</option>
                            </select>
                            <select class="logic-selector">
                                <option value="AND">AND</option>
                                <option value="OR">OR</option>
                            </select>
                            <!-- ä¿®æ”¹ï¼šå°‡+æŒ‰éˆ•ç§»åˆ°æ¯è¡Œå³å´ -->
                            <button class="add-condition-btn-inline">+</button>
                        </div>
                    </div>
                </div>


                <!-- è¼‰å…¥å‹•ç•« -->
                <div id="loading-tech" class="loading">
                    <div class="spinner"></div>
                    <p id="loading-text">æ­£åœ¨é€²è¡ŒæŸ¥è©¢ï¼Œè«‹ç¨å€™...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill"></div>
                        <div class="progress-text" id="progress-text">0%</div>
                    </div>
                </div>

                <!-- é—œéµå­—çµæœ -->
                <div id="keywords-result" style="display: none;">
                    <div class="card">
                        <h3>æœ€çµ‚ä½¿ç”¨çš„é—œéµå­—</h3>
                        <div id="final-keywords" class="keyword-tags"></div>
                    </div>
                </div>

                <!-- æœç´¢çµæœé¡¯ç¤º -->
                <div id="tech-search-results" style="display: none;">
                    <h2>æª¢ç´¢çµæœ</h2>
                    <div class="export-section">
                        <button class="btn btn-export" id="exportExcelBtn" style="display: none;">Excelä¸‹è¼‰</button>
                    </div>
                    <div id="tech-patent-list"></div>
                </div>
            </div>

            <!-- æ¢ä»¶æŸ¥è©¢ -->
            <div id="condition-search" class="tab-content">
                <h2>æ¢ä»¶æŸ¥è©¢</h2>
                <p style="margin-bottom: 2rem; color: #666;">é€éé—œéµæ¬„ä½ç›´æ¥æŸ¥è©¢å°ˆåˆ©</p>

                <div class="card">
                    <h3>æª¢ç´¢æ¢ä»¶</h3>
                    <div class="grid grid-3">
                        <div>
                            <h4>åŸºæœ¬åƒæ•¸</h4>
                            <div class="form-group">
                                <label>ç”³è«‹äºº</label>
                                <input type="text" id="applicant" placeholder="ä¾‹å¦‚ï¼šæ„›å¾—è¬">
                            </div>
                            <div class="form-group">
                                <label>ç™¼æ˜äºº</label>
                                <input type="text" id="inventor" placeholder="ä¾‹å¦‚ï¼šå¼µä¸‰">
                            </div>
                            <div class="form-group">
                                <label>å…¬é–‹å…¬å‘Šè™Ÿ</label>
                                <input type="text" id="patentNumber" placeholder="ä¾‹å¦‚ï¼šTW202436881A">
                            </div>
                            <div class="form-group">
                                <label>ç”³è«‹è™Ÿ</label>
                                <input type="text" id="applicationNumber" placeholder="ä¾‹å¦‚ï¼šTW113115234">
                            </div>
                        </div>
                        <div>
                            <h4>æŠ€è¡“åˆ†é¡</h4>
                            <div class="form-group">
                                <label>IPC åˆ†é¡</label>
                                <input type="text" id="ipcClass" placeholder="ä¾‹å¦‚ï¼šG01R">
                            </div>
                            <div class="form-group">
                                <label>å°ˆåˆ©åç¨±é—œéµå­—</label>
                                <input type="text" id="titleKeyword" placeholder="ä¾‹å¦‚ï¼šæ¸¬è©¦">
                            </div>
                            <div class="form-group">
                                <label>æ‘˜è¦é—œéµå­—</label>
                                <input type="text" id="abstractKeyword" placeholder="ä¾‹å¦‚ï¼šåŠå°é«”">
                            </div>
                            <div class="form-group">
                                <label>å°ˆåˆ©ç¯„åœé—œéµå­—</label>
                                <input type="text" id="claimsKeyword" placeholder="ä¾‹å¦‚ï¼šæ§åˆ¶ç³»çµ±">
                            </div>
                        </div>
                        <div>
                            <h4>æ—¥æœŸç¯„åœ</h4>
                            <div class="form-group">
                                <label>å°ˆåˆ©ç”³è«‹æ—¥ï¼ˆé–‹å§‹ï¼‰</label>
                                <input type="date" id="applicationDateFrom">
                            </div>
                            <div class="form-group">
                                <label>å°ˆåˆ©ç”³è«‹æ—¥ï¼ˆçµæŸï¼‰</label>
                                <input type="date" id="applicationDateTo">
                            </div>
                            <div class="form-group">
                                <label>å…¬é–‹æ—¥ï¼ˆé–‹å§‹ï¼‰</label>
                                <input type="date" id="publicationDateFrom">
                            </div>
                            <div class="form-group">
                                <label>å…¬é–‹æ—¥ï¼ˆçµæŸï¼‰</label>
                                <input type="date" id="publicationDateTo">
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary" id="startConditionSearchBtn">æ¢ä»¶æª¢ç´¢</button>
                </div>

                <!-- è¼‰å…¥å‹•ç•« -->
                <div id="loading-condition" class="loading">
                    <div class="spinner"></div>
                    <p id="loading-text-condition">æ­£åœ¨æŸ¥è©¢ï¼Œè«‹ç¨å€™...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill-condition"></div>
                        <div class="progress-text" id="progress-text-condition">0%</div>
                    </div>
                </div>

                <!-- æœç´¢çµæœé¡¯ç¤º -->
                <div id="condition-search-results" style="display: none;">
                    <h2>æª¢ç´¢çµæœ</h2>
                    <div class="export-section">
                        <button class="btn btn-export" id="exportConditionExcelBtn" style="display: none;">Excelä¸‹è¼‰</button>
                    </div>
                    <div id="condition-patent-list"></div>
                </div>
            </div>

            <!-- Excelæ‰¹é‡åˆ†æ -->
            <div id="excel-analysis" class="tab-content">
                <h2>Excelåˆ†æ</h2>
                <p style="margin-bottom: 2rem; color: #666;">ä¸Šå‚³åŒ…å«å°ˆåˆ©è³‡æ–™çš„Excelæª”æ¡ˆï¼Œç³»çµ±å°‡è‡ªå‹•åˆ†ææ¯ç­†å°ˆåˆ©ä¸¦ç”ŸæˆæŠ€è¡“ç‰¹å¾µèˆ‡åŠŸæ•ˆ</p>

                <div class="card">
                    <h3>æª”æ¡ˆä¸Šå‚³</h3>
                    
                    <div class="upload-requirements">
                        <h4>Excelæª”æ¡ˆè¦æ±‚</h4>
                        <ul>
                            <li><strong>å¿…è¦æ¬„ä½ï¼š</strong>å…¬é–‹å…¬å‘Šè™Ÿã€å°ˆåˆ©åç¨±ã€æ‘˜è¦ã€å°ˆåˆ©ç¯„åœ</li>
                            <li><strong>æª”æ¡ˆæ ¼å¼ï¼š</strong>.xlsx æˆ– .xls</li>
                            <li><strong>æª”æ¡ˆå¤§å°ï¼š</strong>æœ€å¤§ 10MB</li>
                            <li><strong>è³‡æ–™ç­†æ•¸ï¼š</strong>æœ€å¤š 500 ç­†å°ˆåˆ©</li>
                        </ul>
                    </div>

                    <div class="upload-area" id="uploadArea">
                        <div class="upload-instructions">
                            <h4>æ‹–æ”¾Excelæª”æ¡ˆåˆ°æ­¤è™•ï¼Œæˆ–é»æ“Šé¸æ“‡æª”æ¡ˆ</h4>
                            <p>æ”¯æ´ .xlsx å’Œ .xls æ ¼å¼</p>
                        </div>
                        <input type="file" id="excelFileInput" accept=".xlsx,.xls" style="display: none;">
                        <button class="btn btn-primary" id="selectFileBtn">é¸æ“‡Excelæª”æ¡ˆ</button>
                    </div>

                    <div id="fileInfo" class="file-info" style="display: none;">
                        <!-- æª”æ¡ˆè³‡è¨Šå°‡é¡¯ç¤ºåœ¨é€™è£¡ -->
                    </div>

                    <div style="margin-top: 1rem;">
                        <button class="btn btn-success" id="analyzeExcelBtn" style="display: none;" disabled>é–‹å§‹åˆ†æ</button>
                        <button class="btn btn-secondary" id="clearFileBtn" style="display: none;">æ¸…é™¤æª”æ¡ˆ</button>
                    </div>
                </div>

                <!-- è¼‰å…¥å‹•ç•« -->
                <div id="loading-excel" class="loading">
                    <div class="spinner"></div>
                    <p id="loading-text-excel">æ­£åœ¨åˆ†æExcelæª”æ¡ˆï¼Œè«‹ç¨å€™...</p>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill-excel"></div>
                        <div class="progress-text" id="progress-text-excel">0%</div>
                    </div>
                </div>

                <!-- åˆ†æçµæœæ‘˜è¦ -->
                <div id="analysis-summary" class="analysis-summary" style="display: none;">
                    <h4>åˆ†æçµæœæ‘˜è¦</h4>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <div class="stat-number" id="totalPatentsProcessed">0</div>
                            <div class="stat-label">ç¸½è™•ç†ç­†æ•¸</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="successfulAnalysis">0</div>
                            <div class="stat-label">æˆåŠŸåˆ†æ</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="failedAnalysis">0</div>
                            <div class="stat-label">åˆ†æå¤±æ•—</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number" id="analysisMethod">QWEN</div>
                            <div class="stat-label">åˆ†ææ–¹æ³•</div>
                        </div>
                    </div>
                </div>

                <!-- åˆ†æçµæœé¡¯ç¤º -->
                <div id="excel-analysis-results" style="display: none;">
                    <h2>åˆ†æçµæœ</h2>
                    <div class="export-section">
                        <button class="btn btn-export" id="exportAnalysisBtn" style="display: none;">ä¸‹è¼‰åˆ†æçµæœ</button>
                    </div>
                    <div id="excel-patent-list"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- èŠå¤©é¢æ¿ - æ›´æ–°ç‰ˆ -->
    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <div class="chat-header-left">
                <h3>ğŸƒQWEN</h3>
                <div id="memoryIndicator" class="memory-indicator" style="display: none;">
                    <span id="memoryStatus">è¨˜æ†¶æ¨¡å¼</span>
                </div>
            </div>
            <div class="chat-header-right">
                <button class="memory-toggle-btn" id="memoryToggleBtn" title="åˆ‡æ›è¨˜æ†¶æ¨¡å¼">
                    <img 
                        src="./static/iconmonstr-idea-11-240.png"
                        alt="åˆ‡æ›è¨˜æ†¶æ¨¡å¼" 
                        width="24" 
                        height="24"FFFBF0
                    />
                </button>
                <button class="chat-history-btn" id="chatHistoryBtn" title="æŸ¥çœ‹å°è©±æ­·å²">
                    <img 
                        src="./static/iconmonstr-time-17-240.png"
                        alt="æŸ¥çœ‹å°è©±æ­·å²" 
                        width="24" 
                        height="24"
                    />
                </button>
                <button class="clear-memory-btn" id="clearMemoryBtn" title="æ¸…é™¤è¨˜æ†¶">
                    <img 
                        src="./static/iconmonstr-trash-can-27-240.png"
                        alt="æ¸…é™¤è¨˜æ†¶" 
                        width="24" 
                        height="24"
                    />
                </button>
                <button class="chat-close-btn" id="chatCloseBtn">&times;</button>
            </div>
        </div>
        
        <div class="memory-status-panel" id="memoryStatusPanel" style="display: none;">
            <div class="memory-stats">
                <span id="memoryStats">å°è©±è¨˜æ†¶: æº–å‚™ä¸­...</span>
            </div>
        </div>
        
        <div class="chat-status" id="chatStatus">
            ç­‰å¾…æª¢ç´¢çµæœ...
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message assistant">
                <div class="message-content">
                    Hiï¼ğŸƒ
                    <br><br>
                    â—å®Œæˆæª¢ç´¢å¾Œâ—
                    <br><br>
                    æ‰å¯ä»¥å•æˆ‘é—œæ–¼å°ˆåˆ©çš„ä»»ä½•å•é¡Œ
                </div>
                <div class="message-time">ç³»çµ±è¨Šæ¯</div>
            </div>
        </div>
        
        <div class="chat-typing" id="chatTyping">
            ğŸƒæ­£åœ¨æ€è€ƒä¸­...
        </div>
        
        <div class="chat-input-area">
            <div class="chat-mode-selector">
                <label>
                    <input type="checkbox" id="useMemoryCheckbox" checked> 
                    ä½¿ç”¨å°è©±è¨˜æ†¶ (128k tokens)
                </label>
            </div>
            <div class="chat-input-group">
                <textarea class="chat-input" id="chatInput" placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ..." rows="1" disabled></textarea>
                <button class="chat-send-btn" id="chatSendBtn" disabled>â¤</button>
            </div>
        </div>
    </div>

    <!-- èŠå¤©é–‹é—œæŒ‰éˆ• -->
    <button class="chat-toggle-btn" id="chatToggleBtn" title="æ™ºèƒ½å•ç­”">
        <img src="icon_ceV2.ico" alt="Chat Icon" class="chat-icon-img">
    </button>

    <script>
        class ImprovedPatentSearchApp {
            constructor() {
                this.searchResults = {
                    tech: null,
                    condition: null,
                    excel: null
                };
                this.currentTab = 'tech-search';
                this.isSearching = false;
                this.apiBaseUrl = 'http://localhost:8005';
                this.apiKeyVerified = false;
                this.currentSessionId = this.generateSessionId();
                this.generatedKeywords = [];
                this.selectedFile = null;
                this.currentAnalysisResults = null;
                this.progressIntervals = {};
                
                // èŠå¤©ç›¸é—œ
                this.chatResults = null;
                this.chatEnabled = false;
                this.chatHistory = [];
                
                // ğŸ†• å°è©±è¨˜æ†¶ç›¸é—œå±¬æ€§
                this.memoryEnabled = true;
                this.memoryStatus = {
                    cached: false,
                    count: 0,
                    hasHistory: false,
                    ready: false
                };
        
                this.init();
            }

            generateSessionId() {
                return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            determineApiUrl() {
                const hostname = window.location.hostname;
                if (hostname === 'localhost' || hostname === '127.0.0.1') {
                    return 'http://localhost:8005';
                }
                // ç”Ÿç”¢ç’°å¢ƒå¯ä»¥å¾ç’°å¢ƒè®Šæ•¸è®€å–æˆ–ä½¿ç”¨ç›¸å°è·¯å¾‘
                return window.location.origin;
            }

            init() {
                this.cacheElements();
                this.bindEvents();
                this.showWelcomeMessage();
                
                // è‡ªå‹•æ¸¬è©¦APIé€£æ¥
                setTimeout(() => {
                    this.testApiConnection();
                }, 1000);

                // åˆå§‹åŒ–èŠå¤©
                this.initChat();
                this.initEnhancedChat();  // ğŸ†• åˆå§‹åŒ–å¢å¼·ç‰ˆèŠå¤©
            }

            cacheElements() {
                this.elements = {
                    // APIè¨­å®š
                    apiBaseUrl: document.getElementById('apiBaseUrl'),
                    testApiBtn: document.getElementById('testApiBtn'),
                    gpssApiKey: document.getElementById('gpssApiKey'),
                    testGpssBtn: document.getElementById('testGpssBtn'),
                    
                    // ç‹€æ…‹æŒ‡ç¤ºå™¨
                    apiStatus: document.getElementById('apiStatus'),
                    gpssStatus: document.getElementById('gpssStatus'),
                    qwenStatus: document.getElementById('qwenStatus'),
                    
                    // å°ˆåˆ©æŸ¥è©¢
                    patentLookupInput: document.getElementById('patentLookupInput'),
                    patentLookupBtn: document.getElementById('patentLookupBtn'),
                    
                    // åˆ†é å’Œå…§å®¹
                    tabContainer: document.getElementById('tabContainer'),
                    techDescription: document.getElementById('techDescription'),
                    
                    // æ–°çš„é—œéµå­—æµç¨‹
                    generateKeywordsBtn: document.getElementById('generateKeywordsBtn'),
                    keywordSelection: document.getElementById('keyword-selection'),
                    keywordCheckboxGroup: document.getElementById('keyword-checkbox-group'),
                    customKeywords: document.getElementById('customKeywords'),
                    confirmSearchBtn: document.getElementById('confirmSearchBtn'),
                    cancelKeywordBtn: document.getElementById('cancelKeywordBtn'),
                    confirmSynonymSearchBtn: document.getElementById('confirmSynonymSearchBtn'),
                    keywordSynonymGroups: document.getElementById('keyword-synonym-groups'),


                    loadingTech: document.getElementById('loading-tech'),
                    progressFill: document.getElementById('progress-fill'),
                    progressText: document.getElementById('progress-text'),
                    loadingText: document.getElementById('loading-text'),
                    keywordsResult: document.getElementById('keywords-result'),
                    finalKeywords: document.getElementById('final-keywords'),
                    
                    // æŠ€è¡“æœç´¢çµæœ
                    techSearchResults: document.getElementById('tech-search-results'),
                    techPatentList: document.getElementById('tech-patent-list'),
                    exportExcelBtn: document.getElementById('exportExcelBtn'),
                    
                    // æ¢ä»¶æœç´¢
                    startConditionSearchBtn: document.getElementById('startConditionSearchBtn'),
                    loadingCondition: document.getElementById('loading-condition'),
                    conditionSearchResults: document.getElementById('condition-search-results'),
                    conditionPatentList: document.getElementById('condition-patent-list'),
                    exportConditionExcelBtn: document.getElementById('exportConditionExcelBtn'),
                    
                    // æ¢ä»¶æœç´¢è¼¸å…¥
                    applicant: document.getElementById('applicant'),
                    inventor: document.getElementById('inventor'),
                    patentNumber: document.getElementById('patentNumber'),
                    applicationNumber: document.getElementById('applicationNumber'),
                    ipcClass: document.getElementById('ipcClass'),
                    titleKeyword: document.getElementById('titleKeyword'),
                    abstractKeyword: document.getElementById('abstractKeyword'),
                    claimsKeyword: document.getElementById('claimsKeyword'),
                    applicationDateFrom: document.getElementById('applicationDateFrom'),
                    applicationDateTo: document.getElementById('applicationDateTo'),
                    publicationDateFrom: document.getElementById('publicationDateFrom'),
                    publicationDateTo: document.getElementById('publicationDateTo'),

                    // Excelåˆ†æç›¸é—œå…ƒç´ 
                    uploadArea: document.getElementById('uploadArea'),
                    excelFileInput: document.getElementById('excelFileInput'),
                    selectFileBtn: document.getElementById('selectFileBtn'),
                    fileInfo: document.getElementById('fileInfo'),
                    analyzeExcelBtn: document.getElementById('analyzeExcelBtn'),
                    clearFileBtn: document.getElementById('clearFileBtn'),
                    loadingExcel: document.getElementById('loading-excel'),
                    loadingTextExcel: document.getElementById('loading-text-excel'),
                    progressFillExcel: document.getElementById('progress-fill-excel'),
                    progressTextExcel: document.getElementById('progress-text-excel'),
                    analysisSummary: document.getElementById('analysis-summary'),
                    totalPatentsProcessed: document.getElementById('totalPatentsProcessed'),
                    successfulAnalysis: document.getElementById('successfulAnalysis'),
                    failedAnalysis: document.getElementById('failedAnalysis'),
                    analysisMethod: document.getElementById('analysisMethod'),
                    excelAnalysisResults: document.getElementById('excel-analysis-results'),
                    excelPatentList: document.getElementById('excel-patent-list'),
                    exportAnalysisBtn: document.getElementById('exportAnalysisBtn'),

                    // èŠå¤©ç›¸é—œå…ƒç´ 
                    chatPanel: document.getElementById('chatPanel'),
                    chatToggleBtn: document.getElementById('chatToggleBtn'),
                    chatCloseBtn: document.getElementById('chatCloseBtn'),
                    chatMessages: document.getElementById('chatMessages'),
                    chatInput: document.getElementById('chatInput'),
                    chatSendBtn: document.getElementById('chatSendBtn'),
                    chatStatus: document.getElementById('chatStatus'),
                    chatTyping: document.getElementById('chatTyping'),
                    mainContent: document.querySelector('.main-content'),
                    
                    // ğŸ†• å°è©±è¨˜æ†¶ç›¸é—œå…ƒç´ 
                    memoryToggleBtn: document.getElementById('memoryToggleBtn'),
                    chatHistoryBtn: document.getElementById('chatHistoryBtn'),
                    clearMemoryBtn: document.getElementById('clearMemoryBtn'),
                    useMemoryCheckbox: document.getElementById('useMemoryCheckbox'),
                    memoryIndicator: document.getElementById('memoryIndicator'),
                    memoryStatusPanel: document.getElementById('memoryStatusPanel'),
                    memoryStats: document.getElementById('memoryStats'),
                    memoryIcon: document.getElementById('memoryIcon'),
                    memoryStatus: document.getElementById('memoryStatus')
                };
            }

            addConditionRow() {
                const searchConditions = document.getElementById('search-conditions');
                const conditionIndex = searchConditions.children.length;
    
                const newRow = this.createConditionRow(conditionIndex);
                searchConditions.appendChild(newRow);
    
                // é‡æ–°åˆå§‹åŒ–æ–°çš„æ‹–æ”¾å€åŸŸ
                this.initializeDropZones();
            }

            clearAllConditions() {
                // æ¸…é™¤æ‰€æœ‰æ‹–æ”¾å€åŸŸçš„é—œéµå­—
                const allDropZones = document.querySelectorAll('.keywords-dropzone');
                allDropZones.forEach(zone => {
                    const droppedKeywords = zone.querySelector('.dropped-keywords');
                    const hint = zone.querySelector('.dropzone-hint');

                    droppedKeywords.innerHTML = '';
                    if (hint) hint.style.display = 'block';
                });

                // é‡ç½®ç‚ºåªæœ‰ä¸€å€‹æ¢ä»¶è¡Œ
                const searchConditions = document.getElementById('search-conditions');
                const firstRow = searchConditions.querySelector('.condition-row');

                // æ¸…é™¤ç¬¬ä¸€è¡Œçš„å…§å®¹
                const firstDropZone = firstRow.querySelector('.dropped-keywords');
                const firstHint = firstRow.querySelector('.dropzone-hint');
                firstDropZone.innerHTML = '';
                if (firstHint) firstHint.style.display = 'block';

                // é‡ç½®é¸æ“‡å™¨
                firstRow.querySelector('.field-selector').selectedIndex = 0;
                firstRow.querySelector('.logic-selector').selectedIndex = 0;

                // ç§»é™¤å…¶ä»–å¤šé¤˜çš„è¡Œ
                const allRows = searchConditions.querySelectorAll('.condition-row');
                for (let i = 1; i < allRows.length; i++) {
                    allRows[i].remove();
                }

                this.showSuccess('å·²æ¸…é™¤æ‰€æœ‰æœç´¢æ¢ä»¶');
            }

            autoGenerateConditions() {
                // æ¸…é™¤ç¾æœ‰æ¢ä»¶
                this.clearAllConditions();
    
                // ç²å–æ‰€æœ‰é—œéµå­—å’ŒåŒç¾©è©çµ„åˆ
                const keywordsWithSynonyms = this.generatedKeywords || [];
    
                if (keywordsWithSynonyms.length === 0) {
                    this.showError('æ²’æœ‰å¯ç”¨çš„é—œéµå­—çµ„åˆ');
                    return;
                }

                const searchConditions = document.getElementById('search-conditions');

                keywordsWithSynonyms.forEach((group, groupIndex) => {
                    const keyword = group.keyword || '';
                    const synonyms = group.synonyms || [];

                    // æ”¶é›†é€™ä¸€çµ„çš„æ‰€æœ‰è©å½™
                    const allTerms = [];
                    if (keyword) allTerms.push(keyword);
                    allTerms.push(...synonyms);

                    if (allTerms.length === 0) return;

                    let conditionRow;

                    if (groupIndex === 0) {
                        // ä½¿ç”¨ç¬¬ä¸€è¡Œ
                        conditionRow = searchConditions.querySelector('.condition-row');
                    } else {
                        // å‰µå»ºæ–°è¡Œ
                        conditionRow = this.createConditionRow(groupIndex);
                        searchConditions.appendChild(conditionRow);
                    }

                    // å¡«å……é—œéµå­—åˆ°è©²è¡Œ
                    const dropZone = conditionRow.querySelector('.keywords-dropzone');
                    allTerms.forEach(term => {
                        this.addKeywordToDropZone(dropZone, term, 'auto');
                    });

                    // è¨­ç½®æ¬„ä½ç‚ºæ‘˜è¦ï¼ˆé€šå¸¸æ‘˜è¦åŒ…å«æœ€å¤šä¿¡æ¯ï¼‰
                    const fieldSelector = conditionRow.querySelector('.field-selector');
                    fieldSelector.value = 'AB';

                    // è¨­ç½®é‚è¼¯ç‚ºANDï¼ˆé™¤äº†æœ€å¾Œä¸€è¡Œï¼‰
                    const logicSelector = conditionRow.querySelector('.logic-selector');
                        if (groupIndex < keywordsWithSynonyms.length - 1) {
                        logicSelector.value = 'AND';
                        }
                });

                // é‡æ–°åˆå§‹åŒ–æ‹–æ”¾å€åŸŸ
                this.initializeDropZones();

                this.showSuccess(`å·²è‡ªå‹•ç”Ÿæˆ ${keywordsWithSynonyms.length} å€‹æœç´¢æ¢ä»¶çµ„`);
            }

            async manualSearch() {
                // é˜²æ­¢é‡è¤‡æäº¤
                if (this.isSearching) {
                    this.showError('æ­£åœ¨é€²è¡Œæœå°‹ï¼Œè«‹ç¨å€™...');
                    return;
                }

                // é©—è­‰API Key
                if (!this.validateApiKey()) return;

                try {
                    // æ”¶é›†æ‰‹å‹•é…ç½®çš„æœç´¢æ¢ä»¶
                    const searchConditions = this.collectKeywordSynonymSelections();

                    if (searchConditions.length === 0) {
                        this.showError('è«‹å…ˆæ‹–æ‹‰é—œéµå­—åˆ°æœç´¢æ¢ä»¶ä¸­');
                        return;
                    }

                    // æª¢æŸ¥æ¯å€‹æ¢ä»¶æ˜¯å¦éƒ½æœ‰é—œéµå­—
                    const emptyConditions = searchConditions.filter(condition => 
                        !condition.keywords || condition.keywords.length === 0
                    );
            
                    if (emptyConditions.length > 0) {
                        this.showError('è«‹ç¢ºä¿æ¯å€‹æœç´¢æ¢ä»¶éƒ½åŒ…å«é—œéµå­—');
                        return;
                    }
            
                    // ç²å–å¿…è¦çš„åƒæ•¸
                    const description = this.elements.techDescription.value.trim();
                    const gpssApiKey = this.elements.gpssApiKey.value.trim();
            
                    // ç¢ºä¿æœ‰session_id
                    if (!this.currentSessionId) {
                        this.currentSessionId = this.generateSessionId();
                    }
            
                    // é©—è­‰å¿…è¦åƒæ•¸
                    if (!description) {
                        this.showError('è«‹å…ˆè¼¸å…¥æŠ€è¡“æè¿°');
                        return;
                    }
            
                    if (!gpssApiKey) {
                        this.showError('è«‹å…ˆè¼¸å…¥GPSS APIé©—è­‰ç¢¼');
                        return;
                    }
            
                    // è½‰æ›æœç´¢æ¢ä»¶ç‚ºAPIæ‰€éœ€çš„æ ¼å¼
                    const allKeywords = [];
                    searchConditions.forEach(condition => {
                        if (condition.keywords && condition.keywords.length > 0) {
                            allKeywords.push(...condition.keywords);
                        }
                    });
            
                    // å»é‡ä¸¦é©—è­‰
                    const uniqueKeywords = [...new Set(allKeywords)].filter(kw => kw && kw.trim());
                    
                    if (uniqueKeywords.length === 0) {
                        this.showError('æ²’æœ‰æœ‰æ•ˆçš„é—œéµå­—å¯ç”¨æ–¼æœç´¢');
                        return;
                    }
            
                    // ğŸ”§ ä¿®æ­£ï¼šæº–å‚™æ­£ç¢ºçš„APIè«‹æ±‚æ•¸æ“šæ ¼å¼ï¼ˆç¬¦åˆå¾Œç«¯ KeywordConfirmationRequest æ¨¡å‹ï¼‰
                    const requestData = {
                        session_id: this.currentSessionId,
                        description: description,
                        generated_keywords: this.extractGeneratedKeywords(), // ğŸ†• å¿…éœ€å­—æ®µ
                        selected_keywords: uniqueKeywords,                   // ä½¿ç”¨æ”¶é›†åˆ°çš„é—œéµå­—
                        custom_keywords: [],                                 // æ‰‹å‹•æœç´¢ä¸ä½¿ç”¨è‡ªå®šç¾©é—œéµå­—
                        user_code: gpssApiKey,
                        max_results: 1000,
                        use_and_or_logic: false                             // ä½¿ç”¨å‚³çµ±é‚è¼¯
                    };
            
                    console.log('ğŸ¯ æ‰‹å‹•æœç´¢è«‹æ±‚æ•¸æ“š:', JSON.stringify(requestData, null, 2));
            
                    // è¨­ç½®loadingç‹€æ…‹
                    this.isSearching = true;
                    this.elements.loadingTech.classList.add('show');
                    this.elements.keywordSelection.style.display = 'none';
                    this.elements.techSearchResults.style.display = 'none';
            
                    // é¡¯ç¤ºé€²åº¦
                    this.updateProgress(0.3, 'åŸ·è¡Œæ‰‹å‹•é…ç½®æª¢ç´¢...');
                    this.startProgressAnimation('progress-fill', 'progress-text', 45000);

                    // èª¿ç”¨æ­£ç¢ºçš„APIç«¯é»
                    const response = await fetch(`${this.apiBaseUrl}/api/v1/patents/search/tech-description-confirmed`, {
                        method: 'POST',
                        headers: { 
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });
            
                    console.log('ğŸ” APIéŸ¿æ‡‰ç‹€æ…‹:', response.status);
            
                    if (!response.ok) {
                        // ç²å–è©³ç´°éŒ¯èª¤ä¿¡æ¯
                        let errorDetail = 'æœªçŸ¥éŒ¯èª¤';
                        try {
                            const errorData = await response.json();
                            console.error('ğŸ” APIéŒ¯èª¤è©³æƒ…:', errorData);
                            errorDetail = errorData.detail || errorData.message || `HTTP ${response.status}`;
                        } catch (e) {
                            errorDetail = `HTTP ${response.status}: ${response.statusText}`;
                        }
                        throw new Error(errorDetail);
                    }
            
                    const data = await response.json();
                    console.log('ğŸ” æ‰‹å‹•æœç´¢éŸ¿æ‡‰:', data);

                    if (data.success) {
                        // å®Œæˆé€²åº¦
                        this.completeProgress('progress-fill', 'progress-text');
                        
                        // è™•ç†æœç´¢çµæœ
                        this.completeTechSearch(data);
            
                        // é¡¯ç¤ºæœç´¢é‚è¼¯
                        this.displayManualSearchLogic(searchConditions);
            
                        // å•Ÿç”¨èŠå¤©åŠŸèƒ½
                        if (!this.chatEnabled) {
                            this.enableChat();
                        }
            
                        this.showSuccess(`æ‰‹å‹•æœç´¢å®Œæˆï¼æ‰¾åˆ° ${data.total_found || 0} ç­†å°ˆåˆ©`);
            
                    } else {
                        throw new Error(data.detail || data.message || data.error || 'æª¢ç´¢å¤±æ•—');
                    }

                } catch (error) {
                    console.error('æ‰‹å‹•æª¢ç´¢éŒ¯èª¤:', error);
                    this.showError(`æª¢ç´¢å¤±æ•—: ${this.extractErrorMessage(error)}`);
                } finally {
                    // é‡ç½®ç‹€æ…‹
                    this.isSearching = false;
                    this.elements.loadingTech.classList.remove('show');
                    this.resetProgress('progress-fill', 'progress-text');
                }
            }

            extractGeneratedKeywords() {
                // å¾ç•¶å‰ç”Ÿæˆçš„é—œéµå­—ä¸­æå–ä¸»é—œéµå­—
                if (this.generatedKeywords && Array.isArray(this.generatedKeywords)) {
                    return this.generatedKeywords.map(group => group.keyword || '').filter(kw => kw);
                }
    
                // å¦‚æœæ²’æœ‰ç”Ÿæˆçš„é—œéµå­—ï¼Œè¿”å›ç©ºæ•¸çµ„ï¼ˆé€™å°æ–¼æ‰‹å‹•æœç´¢æ˜¯å¯ä»¥æ¥å—çš„ï¼‰
                return [];
            }

            // ğŸ”§ ä¿®æ­£ï¼šæ”¹é€²çš„ collectKeywordSynonymSelections å‡½æ•¸
            collectKeywordSynonymSelections() {
                const searchConditions = [];
                const conditionRows = document.querySelectorAll('.condition-row');

                console.log(`ğŸ” æ‰¾åˆ° ${conditionRows.length} å€‹æ¢ä»¶è¡Œ`);

                conditionRows.forEach((row, index) => {
                    const droppedKeywords = row.querySelectorAll('.dropped-keyword');
                    const fieldSelector = row.querySelector('.field-selector');
                    const logicSelector = row.querySelector('.logic-selector');

                    console.log(`ğŸ” ç¬¬ ${index + 1} è¡Œæœ‰ ${droppedKeywords.length} å€‹é—œéµå­—`);

                    if (droppedKeywords.length > 0) {
                        const keywords = Array.from(droppedKeywords)
                            .map(keyword => {
                                // ç§»é™¤ Ã— ç¬¦è™Ÿä¸¦æ¸…ç†ç©ºç™½
                                const text = keyword.textContent.replace('Ã—', '').trim();
                                console.log(`ğŸ” æå–é—œéµå­—: "${text}"`);
                                return text;
                            })
                            .filter(kw => kw && kw.length > 0); // éæ¿¾ç©ºå­—ä¸²

                        if (keywords.length > 0) {
                            searchConditions.push({
                                keywords: keywords,
                                field: fieldSelector ? fieldSelector.value : 'AB',
                                logic: logicSelector ? logicSelector.value : 'AND',
                                condition_index: index
                            });
                        }
                    }
                });

                console.log('ğŸ” æ”¶é›†åˆ°çš„æœç´¢æ¢ä»¶:', JSON.stringify(searchConditions, null, 2));
                return searchConditions;
            }

            displayManualSearchLogic(searchConditions) {
                const logicParts = [];

                searchConditions.forEach((condition, index) => {
                    const keywords = condition.keywords || [];
                    const field = condition.field || 'AB';
                    const logic = condition.logic || 'AND';

                    if (keywords.length > 0) {
                        const keywordPart = keywords.length > 1 ? 
                            `(${keywords.join(' OR ')})` : keywords[0];

                        const fieldName = field === 'TI' ? 'å°ˆåˆ©åç¨±' : 
                                         field === 'AB' ? 'æ‘˜è¦' : 'å°ˆåˆ©ç¯„åœ';

                        logicParts.push(`${fieldName}: ${keywordPart}`);
                    }
                });

                const finalLogic = logicParts.join(' AND ');

                // é¡¯ç¤ºåœ¨ç•Œé¢ä¸Š
                const searchLogicDiv = document.createElement('div');
                searchLogicDiv.className = 'search-logic-display';
                searchLogicDiv.innerHTML = `
                    <h4>æ‰‹å‹•é…ç½®çš„æœç´¢é‚è¼¯ï¼š</h4>
                    <code style="background: #f5f5f5; padding: 0.5rem; display: block; margin: 0.5rem 0; border-radius: 4px;">
                        ${finalLogic}
                    </code>
                    <p style="color: #666; font-size: 0.9rem; margin-top: 0.5rem;">
                        âœ¨ ç³»çµ±å°‡ä½¿ç”¨ä¸Šè¿°é—œéµå­—åœ¨GPSSè³‡æ–™åº«ä¸­é€²è¡Œæª¢ç´¢
                    </p>
                `;

                // æ’å…¥åˆ°çµæœé¡¯ç¤ºå€åŸŸ
                const resultsDiv = this.elements.keywordsResult;
                if (resultsDiv) {
                    // æ¸…é™¤ä¹‹å‰çš„æœç´¢é‚è¼¯é¡¯ç¤º
                    const existingLogic = resultsDiv.querySelector('.search-logic-display');
                    if (existingLogic) {
                        existingLogic.remove();
                    }

                    resultsDiv.appendChild(searchLogicDiv);
                    resultsDiv.style.display = 'block';
                }
            }

            createConditionRow(conditionIndex) {
                const newRow = document.createElement('div');
                newRow.className = 'condition-row';
                newRow.dataset.conditionIndex = conditionIndex;
    
                newRow.innerHTML = `
                    <div class="keywords-dropzone" data-condition="${conditionIndex}">
                        <span class="dropzone-hint">æ‹–æ‹‰é—œéµå­—åˆ°é€™è£¡</span>
                        <div class="dropped-keywords"></div>
                    </div>
                    <select class="field-selector">
                        <option value="TI">å°ˆåˆ©åç¨±</option>
                        <option value="AB">æ‘˜è¦</option>
                        <option value="CL">å°ˆåˆ©ç¯„åœ</option>
                    </select>
                    <select class="logic-selector">
                        <option value="AND">AND</option>
                        <option value="OR">OR</option>
                    </select>
                    <button class="add-condition-btn-inline">+</button>
                `;
    
                return newRow;
            }

            bindEvents() {
                // åˆ†é åˆ‡æ›
                this.elements.tabContainer.addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab')) {
                        this.showTab(e.target.dataset.tab);
                    }
                });

                // APIæ¸¬è©¦
                this.elements.testApiBtn.addEventListener('click', () => this.testApiConnection());
                this.elements.testGpssBtn.addEventListener('click', () => this.testGpssConnection());

                // å°ˆåˆ©æŸ¥è©¢
                this.elements.patentLookupBtn.addEventListener('click', () => this.lookupPatent());
                this.elements.patentLookupInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.lookupPatent();
                });

                // æ–°çš„é—œéµå­—æµç¨‹ - ä¿®æ­£éƒ¨åˆ†
                document.getElementById('clear-all-conditions-btn').addEventListener('click', () => {
                    this.clearAllConditions();
                });

                document.getElementById('auto-generate-conditions-btn').addEventListener('click', () => {
                    this.autoGenerateConditions();
                });

                // ä¿®æ”¹ï¼šç‚ºå…§è¯+æŒ‰éˆ•ç¶å®šäº‹ä»¶ï¼ˆä½¿ç”¨äº‹ä»¶å§”è¨—ï¼‰
                document.getElementById('manual-search-btn').addEventListener('click', () => {
                    this.manualSearch();
                });

                // é—œéµå­—ç”Ÿæˆå’Œæœç´¢
                this.elements.generateKeywordsBtn.addEventListener('click', () => this.generateKeywords());
                this.elements.confirmSynonymSearchBtn.addEventListener('click', () => this.confirmSynonymSearch());
                this.elements.cancelKeywordBtn.addEventListener('click', () => this.cancelKeywordSelection());

                // æ¢ä»¶æœç´¢
                this.elements.startConditionSearchBtn.addEventListener('click', () => this.startConditionSearch());

                // ExcelåŒ¯å‡º
                this.elements.exportExcelBtn.addEventListener('click', () => this.exportToExcel('tech'));
                this.elements.exportConditionExcelBtn.addEventListener('click', () => this.exportToExcel('condition'));

                // Excelåˆ†æç›¸é—œäº‹ä»¶
                this.elements.selectFileBtn.addEventListener('click', () => this.elements.excelFileInput.click());
                this.elements.excelFileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                this.elements.analyzeExcelBtn.addEventListener('click', () => this.analyzeExcel());
                this.elements.clearFileBtn.addEventListener('click', () => this.clearFile());
                this.elements.exportAnalysisBtn.addEventListener('click', () => this.exportAnalysisResults());

                // æ‹–æ”¾äº‹ä»¶
                this.elements.uploadArea.addEventListener('dragover', (e) => this.handleDragOver(e));
                this.elements.uploadArea.addEventListener('dragleave', (e) => this.handleDragLeave(e));
                this.elements.uploadArea.addEventListener('drop', (e) => this.handleDrop(e));

                // èŠå¤©ç›¸é—œäº‹ä»¶
                this.elements.chatToggleBtn.addEventListener('click', () => this.toggleChat());
                this.elements.chatCloseBtn.addEventListener('click', () => this.closeChat());
                this.elements.chatSendBtn.addEventListener('click', () => this.sendChatMessage());
                this.elements.chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendChatMessage();
                    }
                });
            }       

            // ğŸ†• åˆå§‹åŒ–å¢å¼·ç‰ˆèŠå¤©åŠŸèƒ½
            initEnhancedChat() {
                console.log('åˆå§‹åŒ–å¢å¼·ç‰ˆèŠå¤©åŠŸèƒ½ï¼ˆæ”¯æŒå°è©±è¨˜æ†¶ï¼‰');
                
                // ç¶å®šæ–°çš„èŠå¤©äº‹ä»¶
                if (this.elements.memoryToggleBtn) {
                    this.elements.memoryToggleBtn.addEventListener('click', () => this.toggleMemoryMode());
                }
                
                if (this.elements.chatHistoryBtn) {
                    this.elements.chatHistoryBtn.addEventListener('click', () => this.showChatHistory());
                }
                
                if (this.elements.clearMemoryBtn) {
                    this.elements.clearMemoryBtn.addEventListener('click', () => this.clearChatMemory());
                }
                
                if (this.elements.useMemoryCheckbox) {
                    this.elements.useMemoryCheckbox.addEventListener('change', (e) => {
                        this.memoryEnabled = e.target.checked;
                        this.updateMemoryIndicator();
                    });
                }
                
                // åˆå§‹åŒ–è¨˜æ†¶ç‹€æ…‹
                this.updateMemoryIndicator();
            }

            // èŠå¤©ç›¸é—œæ–¹æ³•
            initChat() {
                console.log('èŠå¤©ç³»çµ±å·²åˆå§‹åŒ–');
            }

            toggleChat() {
                const isOpen = this.elements.chatPanel.classList.contains('open');
                if (isOpen) {
                    this.closeChat();
                } else {
                    this.openChat();
                }
            }

            openChat() {
                this.elements.chatPanel.classList.add('open');
                this.elements.mainContent.classList.add('chat-open');
                this.elements.chatToggleBtn.style.display = 'none';
                
                // å¦‚æœæœ‰æª¢ç´¢çµæœä¸”èŠå¤©æœªå•Ÿç”¨ï¼Œå•Ÿç”¨èŠå¤©
                if (!this.chatEnabled && this.hasAnyResults()) {
                    this.enableChat();
                }
            }

            closeChat() {
                this.elements.chatPanel.classList.remove('open');
                this.elements.mainContent.classList.remove('chat-open');
                this.elements.chatToggleBtn.style.display = 'flex';
            }

            hasAnyResults() {
                return this.searchResults.tech || this.searchResults.condition || this.searchResults.excel;
            }

            enableChat() {
                this.chatEnabled = true;
                this.elements.chatInput.disabled = false;
                this.elements.chatSendBtn.disabled = false;
                this.elements.chatStatus.textContent = 'å·²å°±ç·’ï¼Œå¯ä»¥é–‹å§‹å•ç­”ï¼';
                this.elements.chatStatus.style.background = '#d4edda';
                this.elements.chatStatus.style.color = '#155724';
                
                // æ›´æ–°èŠå¤©æ•¸æ“š
                this.updateChatResults();
                
                // ğŸ†• æ›´æ–°è¨˜æ†¶ç‹€æ…‹
                this.updateMemoryStatus();
                
                console.log('èŠå¤©åŠŸèƒ½å·²å•Ÿç”¨ï¼ˆæ”¯æŒå°è©±è¨˜æ†¶ï¼‰');
            }

            updateChatResults() {
                // åˆä½µæ‰€æœ‰æª¢ç´¢çµæœ
                this.chatResults = {
                    tech: this.searchResults.tech,
                    condition: this.searchResults.condition,
                    excel: this.searchResults.excel,
                    lastUpdated: new Date().toISOString()
                };
                
                console.log('èŠå¤©æ•¸æ“šå·²æ›´æ–°:', this.chatResults);
            }

            // ğŸ†• æ›´æ–°ç™¼é€èŠå¤©æ¶ˆæ¯æ–¹æ³•
            async sendChatMessage() {
                const message = this.elements.chatInput.value.trim();
                if (!message || !this.chatEnabled) return;

                // æ·»åŠ ç”¨æˆ¶æ¶ˆæ¯
                this.addChatMessage('user', message, this.memoryEnabled);
                this.elements.chatInput.value = '';
                
                // é¡¯ç¤ºè¼¸å…¥ä¸­
                this.showTyping();
                
                try {
                    const response = await this.callEnhancedQwenAPI(message, this.memoryEnabled);
                    this.hideTyping();
                    this.addChatMessage('assistant', response.answer, this.memoryEnabled, response);
                    
                    // ğŸ†• æ›´æ–°è¨˜æ†¶ç‹€æ…‹
                    await this.updateMemoryStatus();
                    
                } catch (error) {
                    this.hideTyping();
                    this.addChatMessage('assistant', 'æŠ±æ­‰ï¼Œå›ç­”æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message, false);
                    console.error('èŠå¤©APIéŒ¯èª¤:', error);
                }
            }

            // ğŸ†• èª¿ç”¨å¢å¼·ç‰ˆQWEN API
            async callEnhancedQwenAPI(userMessage, useMemory = true) {
                const endpoint = useMemory ? '/api/v1/patents/qa/ask-with-memory' : '/api/v1/patents/qa/ask-simple';
                
                const payload = {
                    session_id: this.currentSessionId || 'default',
                    question: userMessage,
                    use_memory: useMemory
                };

                const response = await fetch(`${this.apiBaseUrl}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status}`);
                }

                const data = await response.json();
                
                if (data.success) {
                    return data;
                } else {
                    throw new Error(data.error || 'APIå›æ‡‰éŒ¯èª¤');
                }
            }

            // ğŸ†• æ·»åŠ èŠå¤©æ¶ˆæ¯ï¼ˆå¢å¼·ç‰ˆï¼‰
            addChatMessage(type, content, memoryMode, metadata = null) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${type} ${memoryMode ? 'memory-enabled' : 'memory-disabled'}`;
                
                const now = new Date();
                const timeStr = now.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
                
                let metaInfo = '';
                if (metadata && type === 'assistant') {
                    const contextInfo = metadata.context_info || {};
                    metaInfo = `
                        <div class="message-meta">
                            è¨˜æ†¶æ¨¡å¼: ${contextInfo.memory_enabled ? 'é–‹å•Ÿ' : 'é—œé–‰'} | 
                            ä½¿ç”¨æ­·å²: ${contextInfo.conversation_history_used || 0} è¼ª | 
                            åŸ·è¡Œæ™‚é–“: ${(metadata.execution_time || 0).toFixed(2)}s
                        </div>
                    `;
                }
                
                messageDiv.innerHTML = `
                    <div class="message-content">${this.escapeHtml(content)}</div>
                    <div class="message-time">${timeStr}</div>
                    ${metaInfo}
                `;
                
                this.elements.chatMessages.appendChild(messageDiv);
                this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
                
                // ä¿å­˜åˆ°èŠå¤©æ­·å²
                this.chatHistory.push({
                    type: type,
                    content: content,
                    memoryMode: memoryMode,
                    timestamp: now.toISOString(),
                    metadata: metadata
                });
            }

            // ğŸ†• åˆ‡æ›è¨˜æ†¶æ¨¡å¼
            toggleMemoryMode() {
                this.memoryEnabled = !this.memoryEnabled;
                this.elements.useMemoryCheckbox.checked = this.memoryEnabled;
                this.updateMemoryIndicator();
                
                this.addChatMessage('system', 
                    `å°è©±è¨˜æ†¶å·²${this.memoryEnabled ? 'é–‹å•Ÿ' : 'é—œé–‰'}ã€‚` +
                    `${this.memoryEnabled ? 'AIå°‡è¨˜ä½æˆ‘å€‘ä¹‹å‰çš„å°è©±å…§å®¹ã€‚' : 'AIå°‡ä¸æœƒè¨˜ä½ä¹‹å‰çš„å°è©±ã€‚'}`, 
                    false
                );
            }

            // ğŸ†• æ›´æ–°è¨˜æ†¶æŒ‡ç¤ºå™¨
            updateMemoryIndicator() {
                if (!this.elements.memoryIndicator) return;
                
                const indicator = this.elements.memoryIndicator;
                const icon = this.elements.memoryIcon;
                const status = this.elements.memoryStatus;
                
                if (this.memoryEnabled) {
                    indicator.className = 'memory-indicator active';
                    indicator.style.display = 'flex';
                    icon.textContent = 'ğŸ§ ';
                    status.textContent = 'è¨˜æ†¶æ¨¡å¼';
                } else {
                    indicator.className = 'memory-indicator inactive';
                    indicator.style.display = 'flex';
                    icon.textContent = 'âŒ';
                    status.textContent = 'ç°¡å–®æ¨¡å¼';
                }
            }

            // ğŸ†• æ›´æ–°è¨˜æ†¶ç‹€æ…‹
            async updateMemoryStatus() {
                if (!this.currentSessionId) return;
                
                try {
                    const response = await fetch(`${this.apiBaseUrl}/api/v1/patents/qa/memory-status/${this.currentSessionId}`);
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            this.memoryStatus = data.memory_status;
                            this.updateMemoryStatusDisplay();
                        }
                    }
                } catch (error) {
                    console.error('æ›´æ–°è¨˜æ†¶ç‹€æ…‹å¤±æ•—:', error);
                }
            }

            // ğŸ†• æ›´æ–°è¨˜æ†¶ç‹€æ…‹é¡¯ç¤º
            updateMemoryStatusDisplay() {
                if (!this.elements.memoryStats) return;
                
                const status = this.memoryStatus;
                const statsText = `è¨˜æ†¶å¿«å–: ${status.memory_count || 0} è¼ª | ` +
                                 `æ­·å²è¨˜éŒ„: ${status.has_db_history ? 'æœ‰' : 'ç„¡'} | ` +
                                 `æª¢ç´¢çµæœ: ${status.has_search_cache ? 'å¯ç”¨' : 'ç„¡'}`;
                
                this.elements.memoryStats.textContent = statsText;
                
                // é¡¯ç¤º/éš±è—ç‹€æ…‹é¢æ¿
                if (this.elements.memoryStatusPanel) {
                    this.elements.memoryStatusPanel.style.display = 
                        (status.memory_count > 0 || status.has_db_history) ? 'block' : 'none';
                }
            }

            // ğŸ†• é¡¯ç¤ºå°è©±æ­·å²
            async showChatHistory() {
                if (!this.currentSessionId) {
                    alert('æ²’æœ‰ç•¶å‰æœƒè©±ID');
                    return;
                }
                
                try {
                    const response = await fetch(`${this.apiBaseUrl}/api/v1/patents/qa/history/${this.currentSessionId}?limit=20`);
                    const data = await response.json();
                    
                    if (data.success && data.history.length > 0) {
                        let historyHtml = '<div class="modal-body" style="max-height: 60vh; overflow-y: auto; padding: 1rem;">';
                        
                        data.history.forEach((item, index) => {
                            const time = new Date(item.created_at).toLocaleString('zh-TW');
                            historyHtml += `
                                <div class="history-item">
                                    <div class="history-time">${time}</div>
                                    <div class="history-question">å•: ${item.question}</div>
                                    <div class="history-answer">ç­”: ${item.answer.substring(0, 200)}${item.answer.length > 200 ? '...' : ''}</div>
                                </div>
                            `;
                        });
                        
                        historyHtml += '</div>';
                        
                        // å‰µå»ºå°è©±æ­·å²æ¨¡æ…‹æ¡†
                        this.showModal('å°è©±æ­·å²', historyHtml);
                    } else {
                        alert('æš«ç„¡å°è©±æ­·å²');
                    }
                } catch (error) {
                    console.error('ç²å–å°è©±æ­·å²å¤±æ•—:', error);
                    alert('ç²å–å°è©±æ­·å²å¤±æ•—');
                }
            }

            // ğŸ†• æ¸…é™¤èŠå¤©è¨˜æ†¶
            async clearChatMemory() {
                if (!this.currentSessionId) {
                    alert('æ²’æœ‰ç•¶å‰æœƒè©±ID');
                    return;
                }
                
                if (!confirm('ç¢ºå®šè¦æ¸…é™¤å°è©±è¨˜æ†¶å—ï¼Ÿé€™å°‡æ¸…é™¤AIå°ä¹‹å‰å°è©±çš„è¨˜æ†¶ï¼Œä½†ä¸æœƒåˆªé™¤æ­·å²è¨˜éŒ„ã€‚')) {
                    return;
                }
                
                try {
                    const response = await fetch(`${this.apiBaseUrl}/api/v1/patents/qa/clear-memory`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            session_id: this.currentSessionId
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.addChatMessage('system', 'å°è©±è¨˜æ†¶å·²æ¸…é™¤ã€‚AIå°‡ä¸å†è¨˜ä½ä¹‹å‰çš„å°è©±å…§å®¹ã€‚', false);
                        await this.updateMemoryStatus();
                    } else {
                        alert('æ¸…é™¤è¨˜æ†¶å¤±æ•—');
                    }
                } catch (error) {
                    console.error('æ¸…é™¤è¨˜æ†¶å¤±æ•—:', error);
                    alert('æ¸…é™¤è¨˜æ†¶å¤±æ•—');
                }
            }

            // ğŸ†• é¡¯ç¤ºæ¨¡æ…‹æ¡†
            showModal(title, content) {
                // å‰µå»ºæ¨¡æ…‹æ¡†
                const modal = document.createElement('div');
                modal.className = 'modal';
                
                const modalContent = document.createElement('div');
                modalContent.className = 'modal-content';
                
                modalContent.innerHTML = `
                    <div class="modal-header">
                        <h3>${title}</h3>
                        <button class="modal-close" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    ${content}
                `;
                
                modal.appendChild(modalContent);
                document.body.appendChild(modal);
                
                // é»æ“Šå¤–éƒ¨é—œé–‰
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            }

            showTyping() {
                this.elements.chatTyping.classList.add('show');
                this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
            }

            hideTyping() {
                this.elements.chatTyping.classList.remove('show');
            }

            // é€²åº¦æ¢ç›¸é—œæ–¹æ³•
            startProgressAnimation(progressElementId, textElementId, duration = 30000) {
                const progressElement = document.getElementById(progressElementId);
                const textElement = document.getElementById(textElementId);
                
                if (!progressElement || !textElement) return;
                
                // æ¸…é™¤ä¹‹å‰çš„å‹•ç•«
                if (this.progressIntervals[progressElementId]) {
                    clearInterval(this.progressIntervals[progressElementId]);
                }
                
                let progress = 0;
                const increment = 100 / (duration / 1000); // æ¯ç§’å¢åŠ çš„ç™¾åˆ†æ¯”
                
                this.progressIntervals[progressElementId] = setInterval(() => {
                    progress += increment;
                    
                    // é™åˆ¶æœ€å¤§é€²åº¦ç‚º 90%ï¼Œé¿å…åˆ°é” 100%
                    if (progress > 90) {
                        progress = 90;
                    }
                    
                    progressElement.style.width = progress + '%';
                    textElement.textContent = Math.round(progress) + '%';
                }, 1000);
            }

            completeProgress(progressElementId, textElementId) {
                // æ¸…é™¤å‹•ç•«
                if (this.progressIntervals[progressElementId]) {
                    clearInterval(this.progressIntervals[progressElementId]);
                    delete this.progressIntervals[progressElementId];
                }
                
                const progressElement = document.getElementById(progressElementId);
                const textElement = document.getElementById(textElementId);
                
                if (progressElement && textElement) {
                    progressElement.style.width = '100%';
                    textElement.textContent = '100%';
                }
            }

            resetProgress(progressElementId, textElementId) {
                if (this.progressIntervals[progressElementId]) {
                    clearInterval(this.progressIntervals[progressElementId]);
                    delete this.progressIntervals[progressElementId];
                }
                
                const progressElement = document.getElementById(progressElementId);
                const textElement = document.getElementById(textElementId);
                
                if (progressElement && textElement) {
                    progressElement.style.width = '0%';
                    textElement.textContent = '0%';
                }
            }

            showWelcomeMessage() {
                this.showSuccess('æ™ºèƒ½å°ˆåˆ©æª¢ç´¢ç³»çµ±å·²å•Ÿå‹•ï¼è«‹å…ˆè¼¸å…¥GPSS APIé©—è­‰ç¢¼');
                console.log('ç³»çµ±å·²å•Ÿå‹•ï¼Œç­‰å¾…APIé©—è­‰...');
            }

            async testApiConnection() {
                try {
                    console.log(`å˜—è©¦é€£æ¥API: ${this.apiBaseUrl}`);
                    this.updateStatus('apiStatus', 'testing', 'æ¸¬è©¦ä¸­...');
                    
                    const response = await fetch(`${this.apiBaseUrl}/ping`, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });

                    console.log(`APIå›æ‡‰ç‹€æ…‹: ${response.status}`);

                    if (response.ok) {
                        this.updateStatus('apiStatus', 'success', 'API é€£æ¥æ­£å¸¸');
                        await this.testPatentAPI();
                        this.showSuccess('APIé€£æ¥æ¸¬è©¦æˆåŠŸï¼');
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                } catch (error) {
                    console.error('APIé€£æ¥æ¸¬è©¦å¤±æ•—:', error);
                    this.updateStatus('apiStatus', 'error', 'API é€£æ¥å¤±æ•—');
                    this.updateStatus('qwenStatus', 'error', 'æœå‹™ç•°å¸¸');
                    this.showError(`APIé€£æ¥å¤±æ•—: ${this.extractErrorMessage(error)}`);
                }
            }

            async testPatentAPI() {
                try {
                    const response = await fetch(`${this.apiBaseUrl}/api/v1/patents/test/ping`);
                    if (response.ok) {
                        this.updateStatus('qwenStatus', 'success', 'Qwen æœå‹™æ­£å¸¸');
                        console.log('å°ˆåˆ©APIæ¸¬è©¦æˆåŠŸ');
                    } else {
                        console.warn(`å°ˆåˆ©APIæ¸¬è©¦å¤±æ•—: HTTP ${response.status}`);
                        this.updateStatus('qwenStatus', 'warning', 'Qwen æœå‹™éœ€æª¢æŸ¥');
                    }
                } catch (error) {
                    console.error('å°ˆåˆ©APIæ¸¬è©¦éŒ¯èª¤:', error);
                    this.updateStatus('qwenStatus', 'warning', 'Qwen æœå‹™éœ€æª¢æŸ¥');
                }
            }

            async testGpssConnection() {
                try {
                    const apiKey = this.elements.gpssApiKey.value.trim();
                    
                    if (!apiKey) {
                        this.showError('è«‹å…ˆè¼¸å…¥GPSS APIé©—è­‰ç¢¼');
                        return;
                    }

                    if (apiKey.length < 16) {
                        this.showError('GPSS APIé©—è­‰ç¢¼æ ¼å¼ä¸æ­£ç¢ºï¼ˆæ‡‰ç‚º16ä½ä»¥ä¸Šï¼‰');
                        return;
                    }

                    console.log(`æ¸¬è©¦GPSS API: ${apiKey.substring(0, 8)}...`);
                    this.updateStatus('gpssStatus', 'testing', 'GPSS æ¸¬è©¦ä¸­...');

                    const response = await fetch(`${this.apiBaseUrl}/api/v1/patents/test/gpss`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ user_code: apiKey })
                    });

                    console.log(`GPSS APIå›æ‡‰ç‹€æ…‹: ${response.status}`);
                    const data = await response.json();
                    console.log('GPSS APIå›æ‡‰æ•¸æ“š:', data);

                    if (response.ok && data.success) {
                        this.updateStatus('gpssStatus', 'success', 'GPSS API å·²é©—è­‰');
                        this.showSuccess('GPSS APIé€£æ¥æ¸¬è©¦æˆåŠŸï¼');
                        this.apiKeyVerified = true;
                        localStorage.setItem('gpss_api_key', apiKey);
                    } else {
                        this.updateStatus('gpssStatus', 'error', 'GPSS API é©—è­‰å¤±æ•—');
                        this.showError(`GPSS APIé©—è­‰å¤±æ•—: ${data.detail || data.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                        this.apiKeyVerified = false;
                    }
                } catch (error) {
                    console.error('GPSS APIæ¸¬è©¦éŒ¯èª¤:', error);
                    this.updateStatus('gpssStatus', 'error', 'GPSS API é€£æ¥å¤±æ•—');
                    this.showError(`GPSS APIé€£æ¥å¤±æ•—: ${this.extractErrorMessage(error)}`);
                    this.apiKeyVerified = false;
                }
            }

            lookupPatent() {
                const patentNumber = this.elements.patentLookupInput.value.trim();
                if (!patentNumber) {
                    this.showError('è«‹è¼¸å…¥å…¬é–‹å…¬å‘Šè™Ÿ');
                    return;
                }
                
                const url = `https://tiponet.tipo.gov.tw/gpss4/gpsskmc/gpssbkm?!!FRURL${patentNumber}`;
                window.open(url, '_blank');
            }

            async generateKeywords() {
                if (!this.validateApiKey()) return;

                if (this.isSearching) {
                    this.showError('æ­£åœ¨é€²è¡Œè™•ç†ï¼Œè«‹ç¨å€™...');
                    return;
                }

                try {
                    const description = this.elements.techDescription.value.trim();
                    if (!description) {
                        this.showError('è«‹å…ˆè¼¸å…¥æŠ€è¡“æè¿°');
                        return;
                    }

                    if (description.length < 50) {
                        this.showError('æŠ€è¡“æè¿°å¤ªçŸ­ï¼Œè«‹æä¾›æ›´è©³ç´°çš„æè¿°ï¼ˆè‡³å°‘50å€‹å­—ï¼‰');
                        return;
                    }

                    this.isSearching = true;
                    this.elements.generateKeywordsBtn.disabled = true;
                    this.elements.keywordSelection.style.display = 'none';
                    this.updateProgress(0.1, 'æ­£åœ¨ç”Ÿæˆé—œéµå­—...');
                    this.elements.loadingTech.classList.add('show');

                    this.startProgressAnimation('progress-fill', 'progress-text', 10000);

                    const response = await fetch(`${this.apiBaseUrl}/api/v1/patents/keywords/generate-for-confirmation`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            description: description,
                            session_id: this.currentSessionId
                        })
                    });

                    const data = await response.json();
                    
                    if (response.ok && data.success) {
                        this.currentSessionId = data.session_id;
                        this.generatedKeywords = data.generated_keywords;
                        
                        this.completeProgress('progress-fill', 'progress-text');
                        this.showKeywordSelection(data);
                    } else {
                        throw new Error(data.detail || data.message || 'é—œéµå­—ç”Ÿæˆå¤±æ•—');
                    }

                } catch (error) {
                    console.error('é—œéµå­—ç”ŸæˆéŒ¯èª¤:', error);
                    this.showError(`é—œéµå­—ç”Ÿæˆå¤±æ•—: ${this.extractErrorMessage(error)}`);
                } finally {
                    this.isSearching = false;
                    this.elements.generateKeywordsBtn.disabled = false;
                    this.elements.loadingTech.classList.remove('show');
                    this.resetProgress('progress-fill', 'progress-text');
                }
            }

            showKeywordSelection(data) {
                this.generatedKeywords = data.keywords_with_synonyms || [];
                // æ¸…ç©ºä¹‹å‰çš„å…§å®¹
                const availableKeywords = document.getElementById('available-keywords');
                availableKeywords.innerHTML = '';

                // ç”Ÿæˆå¯æ‹–æ‹‰çš„é—œéµå­—å’ŒåŒç¾©è©
                const keywordsWithSynonyms = data.keywords_with_synonyms || [];

                keywordsWithSynonyms.forEach((group, groupIndex) => {
                    const keyword = group.keyword || '';
                    const synonyms = group.synonyms || [];

                    // å‰µå»ºä¸»é—œéµå­—
                    if (keyword) {
                        const keywordDiv = document.createElement('div');
                        keywordDiv.className = 'keyword-item';
                        keywordDiv.textContent = keyword;
                        keywordDiv.draggable = true;
                        keywordDiv.dataset.keyword = keyword;
                        keywordDiv.dataset.type = 'keyword';
                        this.addDragEvents(keywordDiv);
                        availableKeywords.appendChild(keywordDiv);
                    }

                        // å‰µå»ºåŒç¾©è©
                        synonyms.forEach(synonym => {
                        const synonymDiv = document.createElement('div');
                        synonymDiv.className = 'synonym-item';
                        synonymDiv.textContent = synonym;
                        synonymDiv.draggable = true;
                        synonymDiv.dataset.keyword = synonym;
                        synonymDiv.dataset.type = 'synonym';
                        this.addDragEvents(synonymDiv);
                        availableKeywords.appendChild(synonymDiv);
                    });
                });

                // åˆå§‹åŒ–æ‹–æ”¾å€åŸŸ
                this.initializeDropZones();
    
                // é¡¯ç¤ºé—œéµå­—é¸æ“‡ç•Œé¢
                this.elements.keywordSelection.style.display = 'block';
                this.showSuccess(`æˆåŠŸç”Ÿæˆ ${keywordsWithSynonyms.length} å€‹é—œéµå­—çµ„åŠå…¶åŒç¾©è©ï¼Œè«‹æ‹–æ‹‰åˆ°æœç´¢æ¢ä»¶ä¸­`);
            }

            addDragEvents(element) {
                element.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', e.target.dataset.keyword);
                    e.dataTransfer.setData('type', e.target.dataset.type);
                });
            }

            initializeDropZones() {
                const dropZones = document.querySelectorAll('.keywords-dropzone');
                dropZones.forEach(zone => {
                    zone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        zone.classList.add('dragover');
                    });

                    zone.addEventListener('dragleave', () => {
                        zone.classList.remove('dragover');
                    });

                    zone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        zone.classList.remove('dragover');

                        const keyword = e.dataTransfer.getData('text/plain');
                        const type = e.dataTransfer.getData('type');

                        this.addKeywordToDropZone(zone, keyword, type);
                    });
                });
            }

            addKeywordToDropZone(zone, keyword, type) {
                const droppedKeywords = zone.querySelector('.dropped-keywords');
                const hint = zone.querySelector('.dropzone-hint');

                // éš±è—æç¤ºæ–‡å­—
                if (hint) hint.style.display = 'none';

                // æª¢æŸ¥æ˜¯å¦å·²å­˜åœ¨
                    const existingKeywords = Array.from(droppedKeywords.children)
                        .map(child => child.textContent.replace('Ã—', '').trim());

                    if (existingKeywords.includes(keyword)) {
                        return; // å·²å­˜åœ¨ï¼Œä¸é‡è¤‡æ·»åŠ 
                }

                // å‰µå»ºdropped keywordå…ƒç´ 
                const keywordSpan = document.createElement('span');
                keywordSpan.className = 'dropped-keyword';
                keywordSpan.innerHTML = `${keyword} <span class="remove-btn">Ã—</span>`;
    
                // æ·»åŠ ç§»é™¤åŠŸèƒ½
                keywordSpan.querySelector('.remove-btn').addEventListener('click', () => {
                    keywordSpan.remove();
                    if (droppedKeywords.children.length === 0 && hint) {
                        hint.style.display = 'block';
                    }
                });
    
                droppedKeywords.appendChild(keywordSpan);
            }

            collectKeywordSynonymSelections() {
                const searchConditions = [];
                const conditionRows = document.querySelectorAll('.condition-row');

                conditionRows.forEach((row, index) => {
                    const droppedKeywords = row.querySelectorAll('.dropped-keyword');
                    const fieldSelector = row.querySelector('.field-selector');
                    const logicSelector = row.querySelector('.logic-selector');

                    if (droppedKeywords.length > 0) {
                        const keywords = Array.from(droppedKeywords)
                            .map(keyword => keyword.textContent.replace('Ã—', '').trim());

                        searchConditions.push({
                            keywords: keywords,
                            field: fieldSelector.value,
                            logic: logicSelector.value,
                            condition_index: index
                        });
                    }
                });

                return searchConditions;
            }



            async confirmAndSearch() {
                if (this.isSearching) {
                    this.showError('æ­£åœ¨é€²è¡Œæœå°‹ï¼Œè«‹ç¨å€™...');
                    return;
                }

                try {
                    // æ”¶é›†é¸æ“‡çš„é—œéµå­—å’ŒåŒç¾©è©
                    const selectedKeywordGroups = this.collectKeywordSynonymSelections();

                    // æ”¶é›†è‡ªå®šç¾©é—œéµå­—
                    const customKeywordsText = this.elements.customKeywords.value.trim();
                    const customKeywords = customKeywordsText ? 
                        customKeywordsText.split(',').map(k => k.trim()).filter(k => k) : [];

                    // æª¢æŸ¥æ˜¯å¦æœ‰é¸æ“‡
                    if (selectedKeywordGroups.length === 0 && customKeywords.length === 0) {
                        this.showError('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹é—œéµå­—çµ„åˆæˆ–è¼¸å…¥è‡ªå®šç¾©é—œéµå­—');
                        return;
                    }

                    const description = this.elements.techDescription.value.trim();
                    const gpssApiKey = this.elements.gpssApiKey.value.trim();

                    this.isSearching = true;
                    this.elements.confirmSynonymSearchBtn.disabled = true;
                    this.elements.keywordSelection.style.display = 'none';
                    this.elements.loadingTech.classList.add('show');
                    this.elements.techSearchResults.style.display = 'none';

                    this.updateProgress(0.3, 'åŸ·è¡Œé—œéµå­—åŒç¾©è©æª¢ç´¢...');
                    this.startProgressAnimation('progress-fill', 'progress-text', 45000);

                    const response = await fetch(`${this.apiBaseUrl}/api/v1/patents/search/tech-description-with-synonyms`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: this.currentSessionId,
                            description: description,
                            selected_keyword_groups: selectedKeywordGroups,
                            custom_keywords: customKeywords,
                            user_code: gpssApiKey,
                            max_results: 1000
                        })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        this.completeProgress('progress-fill', 'progress-text');
                        this.completeTechSearch(data);

                        // é¡¯ç¤ºä½¿ç”¨çš„æœç´¢é‚è¼¯
                        this.displaySearchLogic(selectedKeywordGroups, customKeywords);

                        // å•Ÿç”¨èŠå¤©åŠŸèƒ½
                        if (!this.chatEnabled) {
                            this.enableChat();
                        }
                    } else {
                        throw new Error(data.detail || data.message || 'æª¢ç´¢å¤±æ•—');
                    }

                } catch (error) {
                    console.error('é—œéµå­—åŒç¾©è©æœç´¢éŒ¯èª¤:', error);
                    this.showError(`æœç´¢å¤±æ•—: ${this.extractErrorMessage(error)}`);
                } finally {
                    this.isSearching = false;
                    this.elements.confirmSynonymSearchBtn.disabled = false;
                    this.elements.loadingTech.classList.remove('show');
                    this.resetProgress('progress-fill', 'progress-text');
                }
            }

            displaySearchLogic(selectedKeywordGroups, customKeywords) {
                const logicParts = [];

                // è™•ç†é—œéµå­—çµ„
                selectedKeywordGroups.forEach((group, index) => {
                    const terms = [];
                if (group.keyword_selected) {
                        terms.push(group.keyword);
                    }
                    terms.push(...group.selected_synonyms);

                    if (terms.length > 0) {
                        logicParts.push(`(${terms.join(' OR ')})`);
                    }
                });

                // è™•ç†è‡ªå®šç¾©é—œéµå­—
                if (customKeywords.length > 0) {
                    logicParts.push(`(${customKeywords.join(' OR ')})`);
                }

                const finalLogic = logicParts.join(' AND ');

                // é¡¯ç¤ºåœ¨ç•Œé¢ä¸Š
                const searchLogicDiv = document.createElement('div');
                searchLogicDiv.className = 'search-logic-display';
                searchLogicDiv.innerHTML = `
                    <h4>ä½¿ç”¨çš„æœç´¢é‚è¼¯ï¼š</h4>
                    <code style="background: #f5f5f5; padding: 0.5rem; display: block; margin: 0.5rem 0; border-radius: 4px;">
                        ${finalLogic}
                    </code>
                `;

                // æ’å…¥åˆ°çµæœé¡¯ç¤ºå€åŸŸ
                const resultsDiv = this.elements.keywordsResult;
                resultsDiv.appendChild(searchLogicDiv);
            }

            async confirmSynonymSearch() {
                if (this.isSearching) {
                    this.showError('æ­£åœ¨é€²è¡Œæœå°‹ï¼Œè«‹ç¨å€™...');
                    return;
                }

                try {
                    // æ”¶é›†é¸æ“‡çš„é—œéµå­—å’ŒåŒç¾©è©çµ„åˆ
                    const selectedKeywordGroups = this.collectKeywordSynonymSelections();

                    // æ”¶é›†è‡ªå®šç¾©é—œéµå­—
                    const customKeywordsText = this.elements.customKeywords.value.trim();
                    const customKeywords = customKeywordsText ? 
                        customKeywordsText.split(',').map(k => k.trim()).filter(k => k) : [];

                    // æª¢æŸ¥æ˜¯å¦æœ‰é¸æ“‡
                    if (selectedKeywordGroups.length === 0 && customKeywords.length === 0) {
                        this.showError('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹é—œéµå­—çµ„åˆæˆ–è¼¸å…¥è‡ªå®šç¾©é—œéµå­—');
                        return;
                    }

                    const description = this.elements.techDescription.value.trim();
                    const gpssApiKey = this.elements.gpssApiKey.value.trim();

                    this.isSearching = true;
                    this.elements.confirmSynonymSearchBtn.disabled = true;
                    this.elements.keywordSelection.style.display = 'none';
                    this.elements.loadingTech.classList.add('show');
                    this.elements.techSearchResults.style.display = 'none';

                    this.updateProgress(0.3, 'åŸ·è¡Œé—œéµå­—åŒç¾©è©æª¢ç´¢...');
                    this.startProgressAnimation('progress-fill', 'progress-text', 45000);

                    const response = await fetch(`${this.apiBaseUrl}/api/v1/patents/search/tech-description-with-synonyms`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            session_id: this.currentSessionId,
                            description: description,
                            selected_keyword_groups: selectedKeywordGroups,
                            custom_keywords: customKeywords,
                            user_code: gpssApiKey,
                            max_results: 1000
                        })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        this.completeProgress('progress-fill', 'progress-text');
                        this.completeTechSearch(data);

                        // å•Ÿç”¨èŠå¤©åŠŸèƒ½
                        if (!this.chatEnabled) {
                            this.enableChat();
                        }
                    } else {
                        throw new Error(data.detail || data.message || 'æª¢ç´¢å¤±æ•—');
                    }

                } catch (error) {
                    console.error('é—œéµå­—åŒç¾©è©æœç´¢éŒ¯èª¤:', error);
                    this.showError(`æœç´¢å¤±æ•—: ${this.extractErrorMessage(error)}`);
                } finally {
                    this.isSearching = false;
                    this.elements.confirmSynonymSearchBtn.disabled = false;
                    this.elements.loadingTech.classList.remove('show');
                    this.resetProgress('progress-fill', 'progress-text');
                }
            }


            

            cancelKeywordSelection() {
                this.elements.keywordSelection.style.display = 'none';
                this.currentSessionId = null;
                this.generatedKeywords = [];
            }

            displayFinalKeywords(keywords) {
                this.elements.finalKeywords.innerHTML = 
                    keywords.map(kw => `<span class="keyword-tag">${kw}</span>`).join('');
                this.elements.keywordsResult.style.display = 'block';
            }

            async startConditionSearch() {
                if (!this.validateApiKey()) return;
                
                if (this.isSearching) {
                    this.showError('æ­£åœ¨é€²è¡Œæœå°‹ï¼Œè«‹ç¨å€™...');   
                    return;
                }

                try {
                    // ğŸ”§ ç¢ºä¿æœ‰session_idï¼Œä½†ä¸è¦æ¯æ¬¡éƒ½é‡æ–°ç”Ÿæˆ
                    if (!this.currentSessionId) {
                        this.currentSessionId = this.generateSessionId();
                    }

                    const searchParams = this.buildConditionSearchParams();

                    console.log('ğŸ” æ¢ä»¶æœå°‹ä½¿ç”¨çš„ session_id:', this.currentSessionId); // ğŸ”§ Debugæ—¥èªŒ

                    if (!this.hasValidConditions(searchParams)) {
                        this.showError('è«‹è‡³å°‘è¼¸å…¥ä¸€å€‹æœç´¢æ¢ä»¶');
                        return;
                    }

                    this.isSearching = true;
                    this.elements.startConditionSearchBtn.disabled = true;
                    this.elements.loadingCondition.classList.add('show');
                    this.elements.conditionSearchResults.style.display = 'none';

                    this.updateConditionProgress(0.3, 'åŸ·è¡Œæ¢ä»¶æª¢ç´¢...');
                    this.startProgressAnimation('progress-fill-condition', 'progress-text-condition', 30000);

                    const searchResults = await this.performConditionSearch(searchParams);

                    this.completeProgress('progress-fill-condition', 'progress-text-condition');
                    this.completeConditionSearch(searchResults);

                    // ğŸ†• æª¢æŸ¥æ˜¯å¦æˆåŠŸæš«å­˜çµæœ
                    if (searchResults.query_info?.cached_for_qa) {
                        this.showSuccess(`æ¢ä»¶æœå°‹å®Œæˆï¼æ‰¾åˆ° ${searchResults.total_found} ç­†å°ˆåˆ©ï¼Œå·²å•Ÿç”¨æ™ºèƒ½å•ç­”åŠŸèƒ½`);
                        console.log('âœ… æœå°‹çµæœå·²æš«å­˜ï¼Œsession_id:', this.currentSessionId); // ğŸ”§ Debugæ—¥èªŒ
                    } else {
                        this.showSuccess(`æ¢ä»¶æœå°‹å®Œæˆï¼æ‰¾åˆ° ${searchResults.total_found} ç­†å°ˆåˆ©`);
                        console.warn('âš ï¸ æœå°‹çµæœæœªæš«å­˜'); // ğŸ”§ Debugæ—¥èªŒ
                    }

                    // å•Ÿç”¨èŠå¤©åŠŸèƒ½
                    if (!this.chatEnabled) {
                        this.enableChat();
                    }

                } catch (error) {
                    console.error('æ¢ä»¶æœç´¢éŒ¯èª¤:', error);
                    this.showError(`æ¢ä»¶æŸ¥è©¢å¤±æ•—: ${this.extractErrorMessage(error)}`);
                } finally {
                    this.isSearching = false;
                    this.elements.startConditionSearchBtn.disabled = false;
                    this.elements.loadingCondition.classList.remove('show');
                    this.resetProgress('progress-fill-condition', 'progress-text-condition');
                }
            }

            buildConditionSearchParams() {
                const params = {
                    user_code: this.elements.gpssApiKey.value.trim(),
                    max_results: 1000,
                    session_id: this.currentSessionId, // ğŸ”§ ä½¿ç”¨ç•¶å‰session_id
                    applicant: this.elements.applicant.value.trim(),
                    inventor: this.elements.inventor.value.trim(),
                    patent_number: this.elements.patentNumber.value.trim(),
                    application_number: this.elements.applicationNumber.value.trim(),
                    ipc_class: this.elements.ipcClass.value.trim(),
                    title_keyword: this.elements.titleKeyword.value.trim(),
                    abstract_keyword: this.elements.abstractKeyword.value.trim(),
                    claims_keyword: this.elements.claimsKeyword.value.trim(),
                    application_date_from: this.elements.applicationDateFrom.value,
                    application_date_to: this.elements.applicationDateTo.value,
                    publication_date_from: this.elements.publicationDateFrom.value,
                    publication_date_to: this.elements.publicationDateTo.value
                };
        
                console.log('ğŸ“¤ ç™¼é€æ¢ä»¶æœå°‹åƒæ•¸:', params); // ğŸ”§ Debugæ—¥èªŒ
                return params;
            }

            hasValidConditions(params) {
                return Object.entries(params)
                    .filter(([key]) => key !== 'user_code' && key !== 'max_results')
                    .some(([key, value]) => value && value.length > 0);
            }

            async performConditionSearch(searchParams) {
                try {
                    const response = await fetch(`${this.apiBaseUrl}/api/v1/patents/condition/search`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(searchParams)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => null);
                        const errorMessage = errorData?.detail || errorData?.message || `HTTP ${response.status}: ${response.statusText}`;
                        throw new Error(errorMessage);
                    }

                    const data = await response.json();
                    
                    return {
                        patents: data.results || [],
                        total: data.total_found || 0,
                        message: data.message || 'æ¢ä»¶æœç´¢å®Œæˆ'
                    };
                    
                } catch (error) {
                    console.error('æ¢ä»¶æŸ¥è©¢APIèª¿ç”¨éŒ¯èª¤:', error);
                    throw new Error(`æ¢ä»¶æŸ¥è©¢APIèª¿ç”¨å¤±æ•—: ${this.extractErrorMessage(error)}`);
                }
            }

            validateApiKey() {
                const apiKey = this.elements.gpssApiKey.value.trim();
                if (!apiKey) {
                    this.showError('è«‹å…ˆè¼¸å…¥GPSS APIé©—è­‰ç¢¼ä¸¦å®Œæˆé©—è­‰');
                    return false;
                }
                if (!this.apiKeyVerified) {
                    this.showError('è«‹å…ˆå®ŒæˆGPSS APIé©—è­‰');
                    return false;
                }
                return true;
            }

            completeTechSearch(searchResults) {
                this.searchResults.tech = searchResults.search_results || searchResults.results || [];
                this.displayTechSearchResults();
                this.showSuccess(`æŠ€è¡“æœå°‹å®Œæˆï¼æ‰¾åˆ° ${searchResults.total_found} ç­†å°ˆåˆ©`);
            }

            completeConditionSearch(searchResults) {
                this.searchResults.tech = searchResults.search_results || searchResults.results || [];  // âœ… ä¿®å¾©
                this.displayTechSearchResults();
                this.showSuccess(`æŠ€è¡“æœå°‹å®Œæˆï¼æ‰¾åˆ° ${searchResults.total_found} ç­†å°ˆåˆ©`);

            }

            displayTechSearchResults() {
                const results = this.searchResults.tech;
                if (!results || !results.length) {
                    this.elements.techPatentList.innerHTML = '<div class="no-results">æ²’æœ‰æ‰¾åˆ°ç›¸é—œçš„å°ˆåˆ©</div>';
                    this.elements.exportExcelBtn.style.display = 'none';
                } else {
                    this.elements.techPatentList.innerHTML = this.generatePatentListHtml(results);
                    this.elements.exportExcelBtn.style.display = 'inline-block';
                }
                this.elements.techSearchResults.style.display = 'block';
            }

            displayConditionSearchResults() {
                const results = this.searchResults.condition;
                if (!results || !results.length) {
                    this.elements.conditionPatentList.innerHTML = '<div class="no-results">æ²’æœ‰æ‰¾åˆ°ç›¸é—œçš„å°ˆåˆ©</div>';
                    this.elements.exportConditionExcelBtn.style.display = 'none';
                } else {
                    this.elements.conditionPatentList.innerHTML = this.generatePatentListHtml(results);
                    this.elements.exportConditionExcelBtn.style.display = 'inline-block';
                }
                this.elements.conditionSearchResults.style.display = 'block';
            }

            generatePatentListHtml(patents) {
                return patents.map((patent, index) => {
                    // è™•ç†å°ˆåˆ©åç¨±å’Œé€£çµ
                    const title = patent['å°ˆåˆ©åç¨±'] || patent.title || 'N/A';
                    const patentLink = patent['å°ˆåˆ©é€£çµ'] || patent.patent_link || '';
                    const publicationNumber = patent['å…¬é–‹å…¬å‘Šè™Ÿ'] || patent.publication_number || 'N/A';

                    // å¦‚æœæœ‰å°ˆåˆ©é€£çµï¼Œå»ºç«‹è¶…é€£çµï¼›å¦‚æœæ²’æœ‰ï¼Œå˜—è©¦ç”¨å…¬é–‹å…¬å‘Šè™Ÿç”Ÿæˆé€£çµ
                    let titleWithLink = title;
                    if (patentLink) {
                        titleWithLink = `<a href="${patentLink}" target="_blank" rel="noopener" style="color: #5a5859; text-decoration: none;">${this.escapeHtml(title)}</a>`;
                    } else if (publicationNumber && publicationNumber !== 'N/A') {
                        const autoGeneratedLink = `https://tiponet.tipo.gov.tw/gpss4/gpsskmc/gpssbkm?!!FRURL${publicationNumber}`;
                        titleWithLink = `<a href="${autoGeneratedLink}" target="_blank" rel="noopener" style="color: #5a5859; text-decoration: none;">${this.escapeHtml(title)}</a>`;
                    } else {
                        titleWithLink = this.escapeHtml(title);
                    }

                    // è™•ç†ç”³è«‹äºº - ä¿®æ­£é¡¯ç¤ºå•é¡Œ
                    let applicants = patent['ç”³è«‹äºº'] || patent.applicants || 'N/A';
                    if (Array.isArray(applicants)) {
                        applicants = applicants.join('; ');
                    }
                    if (!applicants || applicants === 'N/A' || applicants.trim() === '') {
                        applicants = 'ç”³è«‹äººè³‡è¨Šå¾…æŸ¥';
                    }

                    // è™•ç†åœ‹å®¶ - ä¿®æ­£é¡¯ç¤ºå•é¡Œï¼Œå¢åŠ åœ‹å®¶æ¨™è­˜
                    let country = patent['åœ‹å®¶'] || patent.country || 'TW';
                    const countryFlag = this.getCountryFlag(country);
                    const countryDisplay = `${countryFlag} ${this.getCountryName(country)}`;

                    // è™•ç†æ‘˜è¦
                    const abstract = patent['æ‘˜è¦'] || patent.abstract || '';
                    const abstractHtml = abstract && abstract !== 'N/A' && abstract !== 'æš«ç„¡æ‘˜è¦è³‡è¨Š' ? 
                        `<div class="patent-abstract">
                            <h4>â— å°ˆåˆ©æ‘˜è¦</h4>
                            <p>${this.escapeHtml(abstract)}</p>
                         </div>` : '';

                    // è™•ç†æŠ€è¡“ç‰¹å¾µå’ŒåŠŸæ•ˆ
                    const features = patent['æŠ€è¡“ç‰¹å¾µ'] || patent.technical_features || [];
                    const effects = patent['æŠ€è¡“åŠŸæ•ˆ'] || patent.technical_effects || [];
                         
                    const featuresHtml = Array.isArray(features) ? 
                        features.map(f => `<li>${this.escapeHtml(f)}</li>`).join('') :
                        `<li>${this.escapeHtml(features)}</li>`;

                    const effectsHtml = Array.isArray(effects) ? 
                        effects.map(e => `<li>${this.escapeHtml(e)}</li>`).join('') :
                        `<li>${this.escapeHtml(effects)}</li>`;

                    return `
                        <div class="patent-card">
                            <div class="patent-title">${index + 1}. ${titleWithLink}</div>
                            
                            <div class="patent-metadata">
                                <div class="metadata-item">
                                    <span class="metadata-label">å…¬å‘Šè™Ÿ:</span>
                                    <span class="metadata-value">${publicationNumber}</span>
                                </div>
                                <div class="metadata-item">
                                    <span class="metadata-label">ç”³è«‹äºº:</span>
                                    <span class="metadata-value">${this.escapeHtml(applicants)}</span>
                                </div>

                            </div>
                            
                            ${abstractHtml}
                            
                            <div class="features-effects">
                                <div style="margin-bottom: 1rem;">
                                    <h4>â–  æŠ€è¡“ç‰¹å¾µ</h4>
                                    <ul class="features-list">${featuresHtml}</ul>
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <h4>â–² æŠ€è¡“åŠŸæ•ˆ</h4>
                                    <ul class="effects-list">${effectsHtml}</ul>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // åœ‹å®¶ç›¸é—œæ–¹æ³•
            getCountryFlag(country) {
                const flagMap = {
                    'TW': ':',
                    'US': ':', 
                    'JP': ':',
                    'EP': ':',
                    'KR': ':',
                    'CN': ':',
                    'WO': ':',
                    'SEA': ':',
                };
                return flagMap[country] || 'N/A' ;
            }

            getCountryName(country) {
                const nameMap = {
                    'TW': 'TW',
                    'US': 'US',
                    'JP': 'JP',
                    'EP': 'EP',
                    'KR': 'KR',
                    'CN': 'CN',
                    'WO': 'WO',
                    'SEA': 'SEA',
                };
                return nameMap[country] || country;
            }

            // Excelç›¸é—œæ–¹æ³•
            handleDragOver(e) {
                e.preventDefault();
                this.elements.uploadArea.classList.add('dragover');
            }

            handleDragLeave(e) {
                e.preventDefault();
                this.elements.uploadArea.classList.remove('dragover');
            }

            handleDrop(e) {
                e.preventDefault();
                this.elements.uploadArea.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (this.validateExcelFile(file)) {
                        this.setSelectedFile(file);
                    }
                }
            }

            handleFileSelect(e) {
                const file = e.target.files[0];
                if (file && this.validateExcelFile(file)) {
                    this.setSelectedFile(file);
                }
            }

            validateExcelFile(file) {
                // æª¢æŸ¥æª”æ¡ˆé¡å‹
                const validTypes = [
                    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', // .xlsx
                    'application/vnd.ms-excel' // .xls
                ];
                
                const validExtensions = ['.xlsx', '.xls'];
                const fileName = file.name.toLowerCase();
                const hasValidExtension = validExtensions.some(ext => fileName.endsWith(ext));
                
                if (!validTypes.includes(file.type) && !hasValidExtension) {
                    this.showError('è«‹é¸æ“‡æœ‰æ•ˆçš„Excelæª”æ¡ˆ(.xlsx æˆ– .xls)');
                    return false;
                }

                // æª¢æŸ¥æª”æ¡ˆå¤§å° (10MB)
                if (file.size > 10 * 1024 * 1024) {
                    this.showError('æª”æ¡ˆå¤§å°ä¸èƒ½è¶…é10MB');
                    return false;
                }

                return true;
            }

            setSelectedFile(file) {
                this.selectedFile = file;
                
                // é¡¯ç¤ºæª”æ¡ˆè³‡è¨Š
                const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
                this.elements.fileInfo.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <span>ğŸ“„</span>
                        <strong>${file.name}</strong>
                        <span>(${fileSizeMB} MB)</span>
                    </div>
                `;
                this.elements.fileInfo.style.display = 'block';
                
                // é¡¯ç¤ºåˆ†ææŒ‰éˆ•
                this.elements.analyzeExcelBtn.style.display = 'inline-block';
                this.elements.analyzeExcelBtn.disabled = false;
                this.elements.clearFileBtn.style.display = 'inline-block';
                
                this.showSuccess('Excelæª”æ¡ˆå·²é¸æ“‡ï¼Œé»æ“Š"é–‹å§‹åˆ†æ"é€²è¡Œè™•ç†');
            }

            clearFile() {
                this.selectedFile = null;
                this.elements.excelFileInput.value = '';
                this.elements.fileInfo.style.display = 'none';
                this.elements.analyzeExcelBtn.style.display = 'none';
                this.elements.clearFileBtn.style.display = 'none';
                this.elements.excelAnalysisResults.style.display = 'none';
                this.elements.analysisSummary.style.display = 'none';
                this.currentAnalysisResults = null;
            }

            async analyzeExcel() {
                if (!this.selectedFile) {
                    this.showError('è«‹å…ˆé¸æ“‡Excelæª”æ¡ˆ');
                    return;
                }

                if (this.isSearching) {
                    this.showError('ç³»çµ±æ­£åœ¨è™•ç†å…¶ä»–è«‹æ±‚ï¼Œè«‹ç¨å€™...');
                    return;
                }

                try {
                    this.isSearching = true;
                    this.elements.analyzeExcelBtn.disabled = true;
                    this.elements.loadingExcel.classList.add('show');
                    this.updateExcelProgress(0.1, 'æ­£åœ¨ä¸Šå‚³Excelæª”æ¡ˆ...');
                    this.startProgressAnimation('progress-fill-excel', 'progress-text-excel', 60000);

                    // æº–å‚™FormData
                    const formData = new FormData();
                    formData.append('file', this.selectedFile);

                    // ä¸Šå‚³ä¸¦åˆ†æ
                    const response = await fetch(`${this.apiBaseUrl}/api/v1/patents/excel/upload-and-analyze`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => null);
                        throw new Error(errorData?.detail || `HTTP ${response.status}: ${response.statusText}`);
                    }

                    const data = await response.json();
                    
                    if (data.success) {
                        this.completeProgress('progress-fill-excel', 'progress-text-excel');
                        this.completeExcelAnalysis(data);

                        // å•Ÿç”¨èŠå¤©åŠŸèƒ½
                        if (!this.chatEnabled) {
                            this.enableChat();
                        }
                    } else {
                        throw new Error(data.message || 'åˆ†æå¤±æ•—');
                    }

                } catch (error) {
                    console.error('Excelåˆ†æéŒ¯èª¤:', error);
                    this.showError(`Excelåˆ†æå¤±æ•—: ${this.extractErrorMessage(error)}`);
                } finally {
                    this.isSearching = false;
                    this.elements.analyzeExcelBtn.disabled = false;
                    this.elements.loadingExcel.classList.remove('show');
                    this.resetProgress('progress-fill-excel', 'progress-text-excel');
                }
            }

            completeExcelAnalysis(data) {
                this.searchResults.excel = data.results;
                this.currentAnalysisResults = data;
                
                // é¡¯ç¤ºæ‘˜è¦çµ±è¨ˆ
                this.displayAnalysisSummary(data);
                
                // é¡¯ç¤ºåˆ†æçµæœ
                this.displayExcelAnalysisResults(data);
                
                this.showSuccess(`Excelåˆ†æå®Œæˆï¼æˆåŠŸè™•ç† ${data.processed_count} ç­†å°ˆåˆ©ï¼Œå¤±æ•— ${data.errors.length} ç­†`);
            }

            displayAnalysisSummary(data) {
                const totalCount = data.total_count || 0;
                const successCount = data.processed_count || 0;
                const failedCount = data.errors.length || 0;
                
                // åˆ†ææ–¹æ³•çµ±è¨ˆ
                let primaryMethod = 'QWEN';
                if (data.results && data.results.length > 0) {
                    const methodCount = {};
                    data.results.forEach(result => {
                        const method = result['åˆ†ææ–¹æ³•'] || 'unknown';
                        methodCount[method] = (methodCount[method] || 0) + 1;
                    });
                    
                    // æ‰¾å‡ºæœ€å¸¸ç”¨çš„åˆ†ææ–¹æ³•
                    primaryMethod = Object.keys(methodCount).reduce((a, b) => 
                        methodCount[a] > methodCount[b] ? a : b, 'QWEN');
                    
                    // æ ¼å¼åŒ–æ–¹æ³•åç¨±
                    if (primaryMethod === 'qwen_api') primaryMethod = 'Qwen AI';
                    else if (primaryMethod === 'fallback') primaryMethod = 'Fallback';
                    else primaryMethod = 'QWEN';
                }

                this.elements.totalPatentsProcessed.textContent = totalCount;
                this.elements.successfulAnalysis.textContent = successCount;
                this.elements.failedAnalysis.textContent = failedCount;
                this.elements.analysisMethod.textContent = primaryMethod;
                
                this.elements.analysisSummary.style.display = 'block';
            }

            displayExcelAnalysisResults(data) {
                if (!data.results || data.results.length === 0) {
                    this.elements.excelPatentList.innerHTML = '<div class="no-results">æ²’æœ‰æˆåŠŸåˆ†æçš„å°ˆåˆ©è³‡æ–™</div>';
                    this.elements.exportAnalysisBtn.style.display = 'none';
                } else {
                    this.elements.excelPatentList.innerHTML = this.generateExcelAnalysisHtml(data.results);
                    this.elements.exportAnalysisBtn.style.display = 'inline-block';
                }
                
                this.elements.excelAnalysisResults.style.display = 'block';
            }

            generateExcelAnalysisHtml(results) {
                return results.map((result, index) => {
                    const features = result['æŠ€è¡“ç‰¹å¾µ'] || [];
                    const effects = result['æŠ€è¡“åŠŸæ•ˆ'] || [];
                    
                    const featuresHtml = Array.isArray(features) ? 
                        features.map(f => `<li>${this.escapeHtml(f)}</li>`).join('') :
                        `<li>ç„¡æŠ€è¡“ç‰¹å¾µè³‡æ–™</li>`;

                    const effectsHtml = Array.isArray(effects) ? 
                        effects.map(e => `<li>${this.escapeHtml(e)}</li>`).join('') :
                        `<li>ç„¡æŠ€è¡“åŠŸæ•ˆè³‡æ–™</li>`;

                    return `
                        <div class="patent-card">
                            <div class="patent-title">
                                ${result['åºè™Ÿ']}. ${this.escapeHtml(result['å°ˆåˆ©åç¨±'] || 'N/A')}
                            </div>
                            
                            <div class="patent-metadata">
                                <div class="metadata-item">
                                    <span class="metadata-label">å…¬å‘Šè™Ÿ:</span>
                                    <span class="metadata-value">${this.escapeHtml(result['å…¬é–‹å…¬å‘Šè™Ÿ'] || 'N/A')}</span>
                                </div>
                                <div class="metadata-item">
                                    <span class="metadata-label">åŸå§‹è¡Œè™Ÿ:</span>
                                    <span class="metadata-value">${result['åŸå§‹è¡Œè™Ÿ'] || 'N/A'}</span>
                                </div>
                                <div class="metadata-item">
                                    <span class="metadata-label">åˆ†ææ–¹æ³•:</span>
                                    <span class="metadata-value">${this.escapeHtml(result['åˆ†ææ–¹æ³•'] || 'QWEN')}</span>
                                </div>
                            </div>

                            <div class="patent-abstract">
                                <h4>â— å°ˆåˆ©æ‘˜è¦</h4>
                                <p>${this.escapeHtml(result['æ‘˜è¦'] || 'ç„¡æ‘˜è¦è³‡æ–™')}</p>
                            </div>

                            <div class="features-effects">
                                <div style="margin-bottom: 1rem;">
                                    <h4>â–  æŠ€è¡“ç‰¹å¾µ</h4>
                                    <ul class="features-list">${featuresHtml}</ul>
                                </div>
                                <div style="margin-bottom: 1rem;">
                                    <h4>â–² æŠ€è¡“åŠŸæ•ˆ</h4>
                                    <ul class="effects-list">${effectsHtml}</ul>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            async exportAnalysisResults() {
                if (!this.currentAnalysisResults) {
                    this.showError('æ²’æœ‰å¯åŒ¯å‡ºçš„åˆ†æçµæœ');
                    return;
                }

                try {
                    const response = await fetch(`${this.apiBaseUrl}/api/v1/patents/excel/export-analysis-results`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            results: this.currentAnalysisResults.results,
                            session_id: this.currentAnalysisResults.session_id
                        })
                    });

                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = response.headers.get('Content-Disposition')?.split('filename=')[1] || 'excel_analysis_results.xlsx';
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                        
                        this.showSuccess('Excelåˆ†æçµæœå·²ä¸‹è¼‰ï¼');
                    } else {
                        throw new Error('åŒ¯å‡ºå¤±æ•—');
                    }
                } catch (error) {
                    console.error('åŒ¯å‡ºåˆ†æçµæœéŒ¯èª¤:', error);
                    this.showError(`åŒ¯å‡ºå¤±æ•—: ${this.extractErrorMessage(error)}`);
                }
            }

            async exportToExcel(type) {
                try {
                    const results = this.searchResults[type];
                    if (!results || !results.length) {
                        this.showError('æ²’æœ‰å¯åŒ¯å‡ºçš„è³‡æ–™');
                        return;
                    }

                    // æº–å‚™åŒ¯å‡ºæ•¸æ“š
                    const exportData = results.map((patent, index) => {
                        return {
                            'No.': index + 1,
                            'å°ˆåˆ©åç¨±': this.safeStringValue(patent['å°ˆåˆ©åç¨±'] || patent.title),
                            'å°ˆåˆ©é€£çµ': this.safeStringValue(patent['å°ˆåˆ©é€£çµ'] || patent.patent_link || 
                                (patent['å…¬é–‹å…¬å‘Šè™Ÿ'] || patent.publication_number ? 
                                `https://tiponet.tipo.gov.tw/gpss4/gpsskmc/gpssbkm?!!FRURL${patent['å…¬é–‹å…¬å‘Šè™Ÿ'] || patent.publication_number}` : '')),
                            'å…¬é–‹å…¬å‘Šè™Ÿ': this.safeStringValue(patent['å…¬é–‹å…¬å‘Šè™Ÿ'] || patent.publication_number),
                            'ç”³è«‹äºº': this.safeStringValue(patent['ç”³è«‹äºº'] || patent.applicants),
                            'åœ‹å®¶': this.safeStringValue(patent['åœ‹å®¶'] || patent.country),
                            'æ‘˜è¦': this.safeTruncateText(patent['æ‘˜è¦'] || patent.abstract, 500),
                            'å°ˆåˆ©ç¯„åœ': this.safeTruncateText(patent['å°ˆåˆ©ç¯„åœ'] || patent.claims, 500),
                            'æŠ€è¡“ç‰¹å¾µ': this.formatArrayField(patent['æŠ€è¡“ç‰¹å¾µ'] || patent.technical_features || []),
                            'æŠ€è¡“åŠŸæ•ˆ': this.formatArrayField(patent['æŠ€è¡“åŠŸæ•ˆ'] || patent.technical_effects || [])
                        };
                    });

                    // å‰µå»ºExcelæ–‡ä»¶
                    const ws = XLSX.utils.json_to_sheet(exportData);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "å°ˆåˆ©æª¢ç´¢çµæœ");

                    // è¨­ç½®åˆ—å¯¬
                    const colWidths = [
                        { wch: 5 },   // No.
                        { wch: 30 },  // å°ˆåˆ©åç¨±
                        { wch: 50 },  // å°ˆåˆ©é€£çµ
                        { wch: 15 },  // å…¬é–‹å…¬å‘Šè™Ÿ
                        { wch: 20 },  // ç”³è«‹äºº
                        { wch: 8 },   // åœ‹å®¶
                        { wch: 50 },  // æ‘˜è¦
                        { wch: 50 },  // å°ˆåˆ©ç¯„åœ
                        { wch: 30 },  // æŠ€è¡“ç‰¹å¾µ
                        { wch: 30 }   // æŠ€è¡“åŠŸæ•ˆ
                    ];
                    ws['!cols'] = colWidths;

                    // ä¸‹è¼‰æ–‡ä»¶
                    const fileName = `å°ˆåˆ©æª¢ç´¢çµæœ_${type}_${new Date().toISOString().slice(0, 10)}.xlsx`;
                    XLSX.writeFile(wb, fileName);

                    this.showSuccess('Excelæ–‡ä»¶å·²ä¸‹è¼‰ï¼');

                } catch (error) {
                    console.error('ExcelåŒ¯å‡ºéŒ¯èª¤:', error);
                    this.showError(`ExcelåŒ¯å‡ºå¤±æ•—: ${this.extractErrorMessage(error)}`);
                }
            }

            updateExcelProgress(percent, message) {
                this.elements.progressFillExcel.style.width = (percent * 100) + '%';
                this.elements.loadingTextExcel.textContent = message;
            }

            formatArrayField(arr) {
                if (!Array.isArray(arr)) return arr || '';
                return arr.join('; ');
            }

            safeStringValue(value) {
                if (value === null || value === undefined) return 'N/A';
                if (typeof value === 'string') return value || 'N/A';
                if (Array.isArray(value)) return value.join('; ') || 'N/A';
                return String(value) || 'N/A';
            }

            safeTruncateText(value, maxLength) {
                const str = this.safeStringValue(value);
                if (str === 'N/A') return str;
                if (str.length <= maxLength) return str;
                return str.substring(0, maxLength - 3) + '...';
            }

            updateProgress(percent, message) {
                this.elements.progressFill.style.width = (percent * 100) + '%';
                this.elements.loadingText.textContent = message;
            }

            updateConditionProgress(percent, message) {
                const progressFill = document.getElementById('progress-fill-condition');
                const loadingText = document.getElementById('loading-text-condition');
                if (progressFill) progressFill.style.width = (percent * 100) + '%';
                if (loadingText) loadingText.textContent = message;
            }

            updateStatus(elementId, status, message) {
                const element = this.elements[elementId];
                if (!element) return;

                element.className = `status-indicator status-${status}`;
                const icons = { 
                    success: 'âˆš', 
                    error: 'X', 
                    warning: 'âš ', 
                    testing: 'â‡²' 
                };
                const icon = icons[status] || '?';
                element.innerHTML = `<span>${icon}</span> ${message}`;
            }

            showTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                document.querySelectorAll('.tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                
                const targetTab = document.getElementById(tabId);
                if (targetTab) {
                    targetTab.classList.add('active');
                }
                
                const activeTabBtn = document.querySelector(`[data-tab="${tabId}"]`);
                if (activeTabBtn) {
                    activeTabBtn.classList.add('active');
                }
                
                this.currentTab = tabId;
            }

            extractErrorMessage(error) {
                // è™•ç†å„ç¨®éŒ¯èª¤æ ¼å¼
                if (typeof error === 'string') {
                    return error;
                }
                
                if (error instanceof Error) {
                    return error.message;
                }
                
                if (error && typeof error === 'object') {
                    // å˜—è©¦æå–å¸¸è¦‹çš„éŒ¯èª¤å­—æ®µ
                    if (error.detail) {
                        return typeof error.detail === 'string' ? error.detail : JSON.stringify(error.detail);
                    }
                    if (error.message) {
                        return error.message;
                    }
                    if (error.error) {
                        return typeof error.error === 'string' ? error.error : JSON.stringify(error.error);
                    }
                    // å¦‚æœæ˜¯Responseå°è±¡
                    if (error.status && error.statusText) {
                        return `HTTP ${error.status}: ${error.statusText}`;
                    }
                    // æœ€å¾Œå˜—è©¦JSON.stringify
                    try {
                        return JSON.stringify(error);
                    } catch (e) {
                        return 'æœªçŸ¥éŒ¯èª¤';
                    }
                }
                
                return 'æœªçŸ¥éŒ¯èª¤é¡å‹';
            }

            escapeHtml(text) {
                if (!text) return 'N/A';
                if (typeof text !== 'string') return String(text);
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            showError(message) {
                this.showMessage(message, 'error');
            }

            showSuccess(message) {
                this.showMessage(message, 'success');
            }

            showMessage(message, type) {
                const existing = document.querySelector('.temp-message');
                if (existing) existing.remove();

                const div = document.createElement('div');
                div.className = `${type}-message temp-message`;
                const icon = type === 'error' ? 'X' : 'âˆš';
                div.innerHTML = `<strong>${icon} ${type === 'error' ? 'éŒ¯èª¤' : 'æˆåŠŸ'}ï¼š</strong> ${message}`;
                
                const header = document.querySelector('.header');
                header.after(div);
                
                setTimeout(() => {
                    if (div.parentNode) div.parentNode.removeChild(div);
                }, 5000);
            }
        
            async sendQuestionToAPI(userMessage, useMemory) {
                const endpoint = useMemory ? 
                    '/api/v1/patents/qa/ask-with-memory' : '/api/v1/patents/qa/ask-simple';
        
                const payload = {
                    session_id: this.currentSessionId, // ğŸ”§ ä½¿ç”¨ç•¶å‰session_idï¼Œä¸è¦ç”¨ 'default'
                    question: userMessage,
                    use_memory: useMemory
                };

                console.log('ğŸ’¬ ç™¼é€å•ç­”è«‹æ±‚:', payload); // ğŸ”§ Debugæ—¥èªŒ

                const response = await fetch(`${this.apiBaseUrl}${endpoint}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`APIè«‹æ±‚å¤±æ•—: ${response.status}`);
                }

                const data = await response.json();
        
                if (data.success) {
                    return data;
                } else {
                    throw new Error(data.error || 'APIå›æ‡‰éŒ¯èª¤');
                }
            }

            // ğŸ†• æ–°å¢ï¼šDebugæ–¹æ³• - é¡¯ç¤ºç•¶å‰sessionä¿¡æ¯
            showSessionInfo() {
                console.log('ğŸ” ç•¶å‰Sessionä¿¡æ¯:');
                console.log('Session ID:', this.currentSessionId);
                console.log('èŠå¤©å•Ÿç”¨:', this.chatEnabled);
                console.log('è¨˜æ†¶æ¨¡å¼:', this.memoryEnabled);

                // åœ¨ç•«é¢ä¸Šä¹Ÿé¡¯ç¤ºsession_idï¼ˆç”¨æ–¼debugï¼‰
                const sessionDiv = document.getElementById('session-debug');
                if (sessionDiv) {
                    sessionDiv.textContent = `Session ID: ${this.currentSessionId}`;
                }
            }
        }

        // å•Ÿå‹•æ‡‰ç”¨
        document.addEventListener('DOMContentLoaded', function() {
            const app = new ImprovedPatentSearchApp();
            window.patentSearchApp = app;
            console.log('æ”¹é€²ç‰ˆå°ˆåˆ©æª¢ç´¢ç³»çµ±å·²å•Ÿå‹• v2.0 - æ–°å¢æ™ºèƒ½å•ç­”åŠŸèƒ½');
        });
    </script>
</body>
</html>